---
phase: 06.1-add-browser-notifications-to-alert-users-when-needed
plan: 03
type: execute
wave: 2
depends_on: ["06.1-01", "06.1-02"]
files_modified:
  - autopilot/dashboard/src/utils/notification-preferences.ts
  - autopilot/dashboard/src/hooks/usePushSubscription.ts
  - autopilot/dashboard/src/hooks/useBadgeCount.ts
  - autopilot/dashboard/src/components/NotificationToggle.tsx
  - autopilot/dashboard/src/components/Layout.tsx
  - autopilot/dashboard/src/api/client.ts
autonomous: true

must_haves:
  truths:
    - "User can enable/disable notifications per event type (questions, errors, phase-completed, build-complete) via toggles in the header"
    - "Toggle preferences persist in localStorage and survive page refresh"
    - "Dashboard requests notification permission on first visit via soft-ask prompt"
    - "If permission denied, a subtle 'Enable notifications' link appears in the header"
    - "Dashboard subscribes to Web Push and sends subscription to the server"
    - "Pending question count shows as browser badge (progressive enhancement)"
  artifacts:
    - path: "autopilot/dashboard/src/utils/notification-preferences.ts"
      provides: "localStorage persistence for per-type notification toggles"
      exports: ["loadNotificationPreferences", "saveNotificationPreferences", "NotificationPreferences"]
    - path: "autopilot/dashboard/src/hooks/usePushSubscription.ts"
      provides: "React hook for push subscription management"
      exports: ["usePushSubscription"]
    - path: "autopilot/dashboard/src/hooks/useBadgeCount.ts"
      provides: "Badge API integration for pending question count"
      exports: ["useBadgeCount"]
    - path: "autopilot/dashboard/src/components/NotificationToggle.tsx"
      provides: "Notification permission and per-type toggle UI"
      exports: ["NotificationToggle"]
  key_links:
    - from: "autopilot/dashboard/src/hooks/usePushSubscription.ts"
      to: "/api/push/subscribe"
      via: "fetch POST with subscription JSON"
      pattern: "fetch.*push/subscribe"
    - from: "autopilot/dashboard/src/hooks/usePushSubscription.ts"
      to: "/api/push/vapid-public-key"
      via: "fetch GET for VAPID public key"
      pattern: "fetch.*vapid-public-key"
    - from: "autopilot/dashboard/src/components/Layout.tsx"
      to: "autopilot/dashboard/src/components/NotificationToggle.tsx"
      via: "component import in header nav area"
      pattern: "NotificationToggle"
---

<objective>
Build the dashboard-side notification UI: per-type preference toggles, push subscription management, badge count display, and the notification permission flow -- giving users control over which notifications they receive and ensuring their browser is subscribed to push.

Purpose: This connects the browser to the server's push infrastructure (Plan 01) via the Service Worker (Plan 02), and gives users the per-type toggle control specified in the user decisions.

Output: Notification preferences utility, push subscription hook, badge count hook, toggle component in the header, and API client functions for push endpoints.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-add-browser-notifications-to-alert-users-when-needed/06.1-RESEARCH.md
@.planning/phases/06.1-add-browser-notifications-to-alert-users-when-needed/06.1-01-SUMMARY.md
@.planning/phases/06.1-add-browser-notifications-to-alert-users-when-needed/06.1-02-SUMMARY.md

# Key existing files
@autopilot/dashboard/src/components/Layout.tsx
@autopilot/dashboard/src/store/index.ts
@autopilot/dashboard/src/api/client.ts
@autopilot/dashboard/src/hooks/useSSE.ts
@autopilot/dashboard/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification preferences utility and push subscription hook</name>
  <files>
    autopilot/dashboard/src/utils/notification-preferences.ts
    autopilot/dashboard/src/hooks/usePushSubscription.ts
    autopilot/dashboard/src/api/client.ts
  </files>
  <action>
Create `autopilot/dashboard/src/utils/notification-preferences.ts`:
- Export interface `NotificationPreferences` with boolean fields: `questions`, `errors`, `phaseCompleted`, `buildComplete`
- Constant `STORAGE_KEY = 'gsd-notification-preferences'`
- Export `getDefaultPreferences(): NotificationPreferences` returning: questions=true, errors=true, phaseCompleted=false, buildComplete=true (action-needed on by default, informational off except build-complete per Claude's discretion)
- Export `loadNotificationPreferences(): NotificationPreferences`:
  - Try localStorage.getItem, parse JSON, spread over defaults for forward compatibility
  - On error or missing, return defaults
- Export `saveNotificationPreferences(prefs: NotificationPreferences): void`:
  - localStorage.setItem with JSON.stringify
- Export `useNotificationPreferences()` React hook:
  - `const [prefs, setPrefs] = useState<NotificationPreferences>(loadNotificationPreferences)`
  - `updatePref(type: keyof NotificationPreferences, enabled: boolean)` -- updates state and saves to localStorage
  - Listen for `storage` event to sync across tabs (per Pitfall 10 in research): `window.addEventListener('storage', handler)` that checks `e.key === STORAGE_KEY` and reloads prefs
  - Return `{ prefs, updatePref }`

Create `autopilot/dashboard/src/hooks/usePushSubscription.ts`:
- Export `usePushSubscription()` hook
- State: `permission: NotificationPermission` (init from `Notification.permission` or `'default'`), `subscription: PushSubscription | null`, `loading: boolean`
- On mount (`useEffect`):
  - Guard: if `!('serviceWorker' in navigator) || !('PushManager' in window)`, return early (feature detection)
  - Set `permission` from `Notification.permission`
  - Check for existing subscription: `navigator.serviceWorker.ready.then(reg => reg.pushManager.getSubscription())`
  - If exists, set subscription and sync to server via `POST /api/push/subscribe`
- Export `subscribe()` async function:
  - Request permission: `const result = await Notification.requestPermission()`
  - Update permission state
  - If denied or default, return (don't throw)
  - Fetch VAPID public key: `GET /api/push/vapid-public-key` -> `{ publicKey }`
  - Convert key: `urlBase64ToUint8Array(publicKey)` (include this utility function in the file)
  - Subscribe: `registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey })`
  - Send subscription to server: `POST /api/push/subscribe` with `subscription.toJSON()`
  - Update state
- Export `unsubscribe()` async function:
  - If subscription exists, call `subscription.unsubscribe()`
  - Call `DELETE /api/push/subscribe` with `{ endpoint: subscription.endpoint }`
  - Clear state
- Return `{ permission, subscription, loading, subscribe, unsubscribe }`

Add to `autopilot/dashboard/src/api/client.ts`:
- `fetchVapidPublicKey(): Promise<{ publicKey: string }>` -- GET `/api/push/vapid-public-key`
- `subscribePush(subscription: object): Promise<{ ok: boolean }>` -- POST `/api/push/subscribe`
- `unsubscribePush(endpoint: string): Promise<{ ok: boolean }>` -- DELETE `/api/push/subscribe` with body `{ endpoint }`

Include the `urlBase64ToUint8Array` helper function in usePushSubscription.ts (standard VAPID key conversion from base64url to Uint8Array per research code examples).
  </action>
  <verify>
Run `cd autopilot/dashboard && npx tsc --noEmit` -- should compile without errors. Verify all exports are properly typed.
  </verify>
  <done>
Notification preferences persist in localStorage with per-type toggles. Push subscription hook manages the full lifecycle (permission -> subscribe -> sync to server -> unsubscribe). API client has push endpoint functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NotificationToggle component, Badge hook, and wire into Layout</name>
  <files>
    autopilot/dashboard/src/components/NotificationToggle.tsx
    autopilot/dashboard/src/hooks/useBadgeCount.ts
    autopilot/dashboard/src/components/Layout.tsx
  </files>
  <action>
Create `autopilot/dashboard/src/hooks/useBadgeCount.ts`:
- Export `useBadgeCount()` hook
- Subscribe to questions from Zustand store: `useDashboardStore(s => s.questions)`
- `useEffect` on questions change:
  - Count pending questions: `questions.length`
  - Feature detect: `if ('setAppBadge' in navigator)`
  - If count > 0: `navigator.setAppBadge(count).catch(() => {})` (progressive enhancement, silent fail per Pitfall 8)
  - If count === 0: `navigator.clearAppBadge().catch(() => {})`
- No return value (effect-only hook)

Create `autopilot/dashboard/src/components/NotificationToggle.tsx`:
- Import `usePushSubscription` and `useNotificationPreferences`
- Export `NotificationToggle` component
- Layout concept (per user decision: "no dedicated bell icon, just toggle link" in header):
  - When permission is 'default' (first visit): show a subtle link "Enable notifications" that calls `subscribe()` on click. This is the "soft ask" approach recommended by research (request permission after user interaction, not automatic prompt). Per user decision "request on first visit" interpreted as showing the soft ask on first visit.
  - When permission is 'granted': show a small dropdown/popover (toggle-able) with:
    - "Notifications" header text (subtle)
    - Four toggle checkboxes, one per event type: Questions, Errors, Phase completed, Build complete
    - Each checkbox reads from prefs and calls `updatePref(type, !current)` on click
    - A small "Disable all" text link at bottom that calls `unsubscribe()`
  - When permission is 'denied': show a subtle link "Notifications blocked" with title tooltip "Enable in browser settings: chrome://settings/content/notifications" (per Pitfall 1)
- Style with Tailwind:
  - Toggle link: `text-xs text-gray-400 hover:text-gray-200 cursor-pointer`
  - Dropdown: `absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 p-4`
  - Toggles: use simple checkbox inputs with labels
  - Keep it subtle and non-intrusive (per user decision: "persistent but subtle")

Update `autopilot/dashboard/src/components/Layout.tsx`:
- Import `NotificationToggle` from `'../components/NotificationToggle.js'`
- Import `useBadgeCount` from `'../hooks/useBadgeCount.js'`
- Call `useBadgeCount()` at the component top level (effect-only, no return value)
- Place `<NotificationToggle />` in the header nav area, after the "Logs" NavLink, as a flex item. It should sit naturally alongside the navigation links without being intrusive.
  </action>
  <verify>
Run `cd autopilot/dashboard && npx tsc --noEmit` -- should compile without errors. Run `cd autopilot/dashboard && npx vite build` -- should build successfully.
  </verify>
  <done>
Users see a subtle "Enable notifications" link on first visit. After enabling, per-type toggles appear for granular control. Badge count displays pending questions on supported browsers. Layout integrates both the toggle and badge hook.
  </done>
</task>

</tasks>

<verification>
1. `cd autopilot/dashboard && npx tsc --noEmit` compiles without errors
2. `cd autopilot/dashboard && npx vite build` produces valid build output
3. NotificationToggle renders in Layout header after navigation links
4. Preferences persist in localStorage (write, refresh, read back)
5. Push subscription hook makes correct API calls to /api/push/* endpoints
6. Badge hook calls navigator.setAppBadge with correct count
</verification>

<success_criteria>
- Per-type notification toggles work and persist in localStorage (questions, errors, phase-completed, build-complete)
- Soft-ask permission flow on first visit (not aggressive auto-prompt)
- Push subscription sent to server after permission granted
- Denied permission shows help text
- Badge API integrated as progressive enhancement
- Layout header includes notification controls without cluttering UI
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-add-browser-notifications-to-alert-users-when-needed/06.1-03-SUMMARY.md`
</output>
