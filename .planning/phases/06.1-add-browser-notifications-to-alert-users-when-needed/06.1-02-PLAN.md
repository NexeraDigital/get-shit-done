---
phase: 06.1-add-browser-notifications-to-alert-users-when-needed
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - autopilot/dashboard/package.json
  - autopilot/dashboard/vite.config.ts
  - autopilot/dashboard/src/service-worker.ts
  - autopilot/dashboard/public/icon-192.png
  - autopilot/dashboard/public/icon-512.png
  - autopilot/dashboard/public/badge-72.png
  - autopilot/dashboard/public/notification-sound.mp3
autonomous: true

must_haves:
  truths:
    - "vite-plugin-pwa is installed and configured in vite.config.ts with injectManifest strategy"
    - "Service Worker handles push events and displays notifications with correct title prefix and behavior"
    - "Clicking a notification opens or focuses the dashboard at the correct URL"
    - "Service Worker is registered automatically on page load"
    - "PWA manifest includes GSD branding (name, icons)"
  artifacts:
    - path: "autopilot/dashboard/src/service-worker.ts"
      provides: "Push event handler, notification click handler, activate/install handlers"
      contains: "self.addEventListener('push'"
    - path: "autopilot/dashboard/vite.config.ts"
      provides: "PWA plugin configuration with injectManifest strategy"
      contains: "VitePWA"
    - path: "autopilot/dashboard/public/icon-192.png"
      provides: "PWA icon 192x192"
    - path: "autopilot/dashboard/public/icon-512.png"
      provides: "PWA icon 512x512"
  key_links:
    - from: "autopilot/dashboard/src/service-worker.ts"
      to: "ServiceWorkerGlobalScope"
      via: "push and notificationclick event listeners"
      pattern: "addEventListener.*push|notificationclick"
    - from: "autopilot/dashboard/vite.config.ts"
      to: "autopilot/dashboard/src/service-worker.ts"
      via: "vite-plugin-pwa injectManifest srcDir + filename"
      pattern: "filename.*service-worker"
---

<objective>
Set up the PWA Service Worker with vite-plugin-pwa so push notifications can be received and displayed even when the dashboard tab is closed or browser is in background.

Purpose: The Service Worker is the bridge between server-side push and browser-side notification display. Without it, notifications only work when the dashboard tab is open and focused.

Output: A configured Service Worker with push/click handlers, vite-plugin-pwa integration, PWA manifest, and required icon/sound assets.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-add-browser-notifications-to-alert-users-when-needed/06.1-RESEARCH.md

# Key existing files
@autopilot/dashboard/vite.config.ts
@autopilot/dashboard/package.json
@autopilot/dashboard/tsconfig.json
@autopilot/dashboard/src/main.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vite-plugin-pwa and create Service Worker with push handlers</name>
  <files>
    autopilot/dashboard/package.json
    autopilot/dashboard/vite.config.ts
    autopilot/dashboard/src/service-worker.ts
  </files>
  <action>
Install vite-plugin-pwa as a dev dependency in the dashboard directory:
```bash
cd autopilot/dashboard && npm install vite-plugin-pwa -D
```

Update `autopilot/dashboard/vite.config.ts`:
- Import `VitePWA` from `'vite-plugin-pwa'`
- Add VitePWA to plugins array AFTER react() and tailwindcss()
- Configuration:
  - `strategies: 'injectManifest'` (custom Service Worker)
  - `srcDir: 'src'`
  - `filename: 'service-worker.ts'`
  - `registerType: 'autoUpdate'`
  - `injectRegister: 'auto'` (auto-registers SW on page load -- per user decision: "request notification permission on first dashboard visit")
  - `manifest` object:
    - `name: 'GSD Autopilot Dashboard'`
    - `short_name: 'GSD'`
    - `description: 'Get Shit Done Autopilot Dashboard'`
    - `theme_color: '#1f2937'` (matches gray-900 header)
    - `background_color: '#f9fafb'` (matches gray-50 background)
    - `display: 'standalone'`
    - `icons`: array with 192x192 and 512x512 entries (type: 'image/png', purpose: 'any maskable')
  - `devOptions: { enabled: true, type: 'module' }` for dev testing
- Keep existing react(), tailwindcss() plugins and server proxy config unchanged

Create `autopilot/dashboard/src/service-worker.ts`:
- Add `/// <reference lib="webworker" />` at top
- Declare `const self: ServiceWorkerGlobalScope` (or use `declare const self`)
- Import `{ precacheAndRoute } from 'workbox-precaching'` and call `precacheAndRoute(self.__WB_MANIFEST)` for Workbox precaching support (required by injectManifest strategy)

**Push event handler** (`self.addEventListener('push', ...)`):
- If no `event.data`, return early
- Parse JSON payload: `event.data.json()` into `{ title, body, icon, badge, tag, requireInteraction, silent, data }`
- Call `event.waitUntil(self.registration.showNotification(title, { ... }))` with:
  - `body` from payload
  - `icon`: payload.icon or `'/icon-192.png'` (GSD logo -- per user decision: custom icon for brand recognition)
  - `badge`: `'/badge-72.png'`
  - `tag`: from payload (enables notification grouping -- per user decision)
  - `requireInteraction`: from payload (questions persist, informational auto-dismiss -- per user decision)
  - `silent`: from payload (questions are not silent, others are -- per user decision)
  - `data`: spread payload.data (stores url and notification type for click handler)

**Notification click handler** (`self.addEventListener('notificationclick', ...)`):
- Close the notification: `event.notification.close()`
- Extract URL from `event.notification.data?.url || '/'`
- Build full URL using `new URL(url, self.location.origin).href`
- `event.waitUntil(...)`:
  - Use `self.clients.matchAll({ type: 'window', includeUncontrolled: true })`
  - If a matching window exists (same origin), navigate it using `client.navigate(fullUrl)` then `client.focus()` (per user decision: click navigates to relevant page)
  - If no match, `self.clients.openWindow(fullUrl)` (per user decision: opens new tab)

**Activate handler**: Call `self.clients.claim()` to take control of existing clients immediately.

**Install handler**: Call `self.skipWaiting()` for immediate activation of new SW versions.
  </action>
  <verify>
Run `cd autopilot/dashboard && npx tsc --noEmit` -- should compile. Run `cd autopilot/dashboard && npx vite build` -- should produce dist/ with service worker file. Check that the build output includes a sw.js or service-worker.js file.
  </verify>
  <done>
Service Worker is configured with push/click handlers and builds successfully via vite-plugin-pwa. Notification clicks navigate to the correct dashboard page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PWA icons, badge, and notification sound assets</name>
  <files>
    autopilot/dashboard/public/icon-192.png
    autopilot/dashboard/public/icon-512.png
    autopilot/dashboard/public/badge-72.png
    autopilot/dashboard/public/notification-sound.mp3
  </files>
  <action>
Create the `autopilot/dashboard/public/` directory if it does not exist.

Generate simple placeholder PWA icon files. Since we need actual PNG files for the PWA manifest to work:

**For icon-192.png (192x192)** and **icon-512.png (512x512)**:
Use a Node.js script to generate minimal PNG files with the text "GSD" as branding. If creating proper PNGs is complex without image libraries, create minimal valid PNG files (even 1-color solid squares are fine as placeholders -- the important thing is they are valid PNG format).

The simplest approach: Use a small Node.js script that creates valid minimal PNG files using raw binary data. A solid dark gray (#1f2937) square is sufficient. The exact approach is Claude's discretion per user decision on "custom GSD icon/logo."

**For badge-72.png (72x72)**:
Same approach -- minimal valid PNG for browser badge display. Solid color square.

**For notification-sound.mp3**:
Per research, browsers do NOT support custom notification sounds via the Notifications API `sound` property. However, the user decision says "custom notification sound for questions only." The workaround documented in research: play audio via `<audio>` element when the dashboard tab is open.

Create a minimal valid MP3 file or a very short audio file. A simple short "ding" tone. If generating audio is complex, create a minimal placeholder MP3 file. The actual sound playback will be wired in Plan 03 (foreground notification hook plays audio via HTML Audio API when SSE event fires).

The critical thing: all four files must exist and be valid for their format so the build doesn't fail and the PWA manifest works.
  </action>
  <verify>
Verify all four files exist in `autopilot/dashboard/public/`. Run `cd autopilot/dashboard && npx vite build` and confirm the build succeeds with assets copied to dist/. Check that the PWA manifest in the build output references the icon files.
  </verify>
  <done>
PWA icons, badge, and notification sound placeholder assets exist and are included in the build output. The PWA manifest references valid icon files.
  </done>
</task>

</tasks>

<verification>
1. `cd autopilot/dashboard && npx vite build` succeeds and produces dist/ with Service Worker
2. Service Worker file in dist/ contains push and notificationclick handlers
3. PWA manifest in dist/ references icon-192.png and icon-512.png
4. All public/ assets are copied to dist/ during build
5. `cd autopilot && npx tsc --noEmit` passes (server side still compiles)
</verification>

<success_criteria>
- vite-plugin-pwa configured with injectManifest strategy
- Service Worker receives push events and displays notifications with GSD branding
- Notification clicks navigate to correct dashboard pages
- Service Worker auto-registers and auto-updates
- All required PWA assets exist and build correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-add-browser-notifications-to-alert-users-when-needed/06.1-02-SUMMARY.md`
</output>
