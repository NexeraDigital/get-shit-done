---
phase: 06.1-add-browser-notifications-to-alert-users-when-needed
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autopilot/src/server/push/vapid.ts
  - autopilot/src/server/push/subscription-store.ts
  - autopilot/src/server/push/manager.ts
  - autopilot/src/server/routes/push.ts
autonomous: true

must_haves:
  truths:
    - "Server generates or loads VAPID keys on startup without crashing"
    - "Dashboard can POST a push subscription to /api/push/subscribe and GET the VAPID public key from /api/push/vapid-public-key"
    - "PushNotificationManager can send a push notification to all registered subscriptions"
    - "Expired or invalid subscriptions (404/410) are automatically removed"
  artifacts:
    - path: "autopilot/src/server/push/vapid.ts"
      provides: "VAPID key generation and loading"
      exports: ["loadVAPIDKeys"]
    - path: "autopilot/src/server/push/subscription-store.ts"
      provides: "In-memory push subscription storage"
      exports: ["SubscriptionStore"]
    - path: "autopilot/src/server/push/manager.ts"
      provides: "Push notification delivery via web-push"
      exports: ["PushNotificationManager"]
    - path: "autopilot/src/server/routes/push.ts"
      provides: "REST endpoints for push subscription management"
      exports: ["createPushRoutes"]
  key_links:
    - from: "autopilot/src/server/push/manager.ts"
      to: "web-push"
      via: "webpush.sendNotification()"
      pattern: "webpush\\.sendNotification"
    - from: "autopilot/src/server/routes/push.ts"
      to: "autopilot/src/server/push/subscription-store.ts"
      via: "store.add() and store.remove()"
      pattern: "store\\.(add|remove)"
---

<objective>
Create the server-side Web Push infrastructure: VAPID key management, push subscription storage, a PushNotificationManager class that wraps the web-push library, and REST endpoints for subscription management.

Purpose: This is the server backbone enabling push notifications to reach browsers even when the dashboard tab is closed. Without this, notifications can only work when the tab is open.

Output: Four new server modules (vapid.ts, subscription-store.ts, manager.ts, routes/push.ts) and the web-push npm dependency installed.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-add-browser-notifications-to-alert-users-when-needed/06.1-RESEARCH.md

# Key existing files
@autopilot/src/server/index.ts
@autopilot/src/server/routes/api.ts
@autopilot/package.json
@autopilot/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install web-push, create VAPID key manager and subscription store</name>
  <files>
    autopilot/package.json
    autopilot/src/server/push/vapid.ts
    autopilot/src/server/push/subscription-store.ts
    autopilot/.gitignore
  </files>
  <action>
Install the web-push npm package as a production dependency and @types/web-push as a devDependency in the autopilot/ directory:
```bash
cd autopilot && npm install web-push && npm install @types/web-push -D
```

Create `autopilot/src/server/push/vapid.ts`:
- Export an async function `loadVAPIDKeys()` that returns `{ publicKey: string; privateKey: string; subject: string }`
- Check environment variables first: `VAPID_PUBLIC_KEY`, `VAPID_PRIVATE_KEY`, `VAPID_SUBJECT`
- If env vars not set, check for `.vapid-keys.json` in the project's `.planning/` directory (not cwd -- use the project dir passed as argument)
- If file not found, generate new keys via `webpush.generateVAPIDKeys()`, persist to `.planning/.vapid-keys.json`, and log generation
- Subject defaults to `'mailto:dev@gsd-autopilot.local'`
- The function signature: `loadVAPIDKeys(planningDir: string): Promise<VAPIDKeys>`
- Export the `VAPIDKeys` interface

Create `autopilot/src/server/push/subscription-store.ts`:
- Export a `SubscriptionStore` class with an in-memory `Map<string, PushSubscription>` (key = subscription endpoint URL)
- Methods: `add(subscription: PushSubscription): string` (returns the endpoint as key), `remove(key: string): boolean`, `getAll(): PushSubscription[]`, `size(): number`
- PushSubscription type from web-push: `{ endpoint: string; keys: { p256dh: string; auth: string } }`
- Export the `PushSubscription` type alias for web-push's subscription shape

Add `.vapid-keys.json` to `autopilot/.gitignore` to prevent committing VAPID private keys.

Use ESM imports with `.js` extensions per project convention. Use `export type` for type-only exports per `verbatimModuleSyntax`.
  </action>
  <verify>
Run `cd autopilot && npx tsc --noEmit` -- should compile without errors. Verify web-push and @types/web-push appear in package.json. Verify `.vapid-keys.json` is in .gitignore.
  </verify>
  <done>
VAPID keys can be generated/loaded, subscriptions can be stored/retrieved in memory, and VAPID private keys are git-ignored.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PushNotificationManager and push subscription REST routes</name>
  <files>
    autopilot/src/server/push/manager.ts
    autopilot/src/server/routes/push.ts
  </files>
  <action>
Create `autopilot/src/server/push/manager.ts`:
- Import webpush (default import: `import webpush from 'web-push'`) and the VAPIDKeys type
- Export class `PushNotificationManager` with constructor accepting `VAPIDKeys` -- calls `webpush.setVapidDetails(keys.subject, keys.publicKey, keys.privateKey)` in constructor
- Inject `SubscriptionStore` via constructor
- Method `async sendToAll(payload: PushPayload): Promise<void>`:
  - `PushPayload` interface: `{ title: string; body: string; tag?: string; requireInteraction?: boolean; silent?: boolean; url?: string; icon?: string; data?: Record<string, unknown> }`
  - Serializes payload to JSON string
  - Calls `webpush.sendNotification(sub, jsonPayload, { TTL: 3600, urgency: requireInteraction ? 'high' : 'normal' })` for each subscription via `Promise.allSettled`
  - On 404 or 410 errors, removes the subscription from the store (expired/invalid)
  - Logs failures with `console.warn`
- Method `getVapidPublicKey(): string` returns the public key for client-side subscription
- Export the `PushPayload` type

Create `autopilot/src/server/routes/push.ts`:
- Export function `createPushRoutes(deps: PushRouteDeps): Router`
- `PushRouteDeps` interface: `{ subscriptionStore: SubscriptionStore; vapidPublicKey: string }`
- Route `GET /vapid-public-key` -- returns `{ publicKey: string }`
- Route `POST /subscribe` -- accepts `{ endpoint: string; keys: { p256dh: string; auth: string } }` body, validates required fields, adds to subscription store, returns `{ ok: true }`
- Route `DELETE /subscribe` -- accepts `{ endpoint: string }` body, removes from store, returns `{ ok: true }`
- Use Express Router, follow existing route factory pattern from `routes/api.ts`
- These routes will be mounted at `/api/push` by the ResponseServer (wiring done in Plan 04)
  </action>
  <verify>
Run `cd autopilot && npx tsc --noEmit` -- should compile without errors. Verify both files export their main class/function correctly.
  </verify>
  <done>
PushNotificationManager can deliver notifications to all stored subscriptions with automatic cleanup of expired ones. REST routes are ready for subscription management.
  </done>
</task>

</tasks>

<verification>
1. `cd autopilot && npx tsc --noEmit` passes with zero errors
2. web-push package is in dependencies, @types/web-push in devDependencies
3. `.vapid-keys.json` is in .gitignore
4. All four new files exist and export their documented interfaces
5. No circular imports between the new push modules
</verification>

<success_criteria>
- Server-side push infrastructure compiles and is ready for wiring
- VAPID key generation/loading handles both env var and file-based approaches
- Subscription store provides clean add/remove/getAll interface
- Push routes follow existing Express Router factory pattern
- Expired subscriptions are automatically cleaned up on send failure
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-add-browser-notifications-to-alert-users-when-needed/06.1-01-SUMMARY.md`
</output>
