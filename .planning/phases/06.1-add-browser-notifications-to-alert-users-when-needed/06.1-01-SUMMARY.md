---
phase: 06.1-add-browser-notifications-to-alert-users-when-needed
plan: 01
subsystem: server-push-infrastructure
tags:
  - web-push
  - vapid
  - notification-backend
  - rest-api
dependency_graph:
  requires: []
  provides:
    - server-push-infrastructure
    - vapid-key-management
    - subscription-storage
    - push-rest-endpoints
  affects:
    - autopilot/src/server/index.ts (future wiring in Plan 04)
tech_stack:
  added:
    - web-push@3.6.7 (production)
    - "@types/web-push@3.6.4" (dev)
  patterns:
    - VAPID key management with env var/file/generation fallback
    - In-memory subscription store with Map keyed by endpoint
    - Express Router factory pattern for push routes
    - Automatic expired subscription cleanup on send failure
key_files:
  created:
    - autopilot/src/server/push/vapid.ts
    - autopilot/src/server/push/subscription-store.ts
    - autopilot/src/server/push/manager.ts
    - autopilot/src/server/routes/push.ts
  modified:
    - autopilot/package.json
    - autopilot/package-lock.json
    - autopilot/.gitignore
decisions:
  - "Use web-push library for Web Push protocol implementation"
  - "VAPID keys stored in .planning/.vapid-keys.json with .gitignore protection"
  - "In-memory subscription storage (production would use database)"
  - "Automatic cleanup of expired subscriptions (404/410 HTTP status)"
  - "Express Router factory pattern consistent with routes/api.ts"
metrics:
  duration_seconds: 128
  tasks_completed: 2
  files_created: 4
  files_modified: 3
  commits: 2
  completed_at: "2026-02-24T18:58:01Z"
---

# Phase 06.1 Plan 01: Server-Side Web Push Infrastructure Summary

Server-side Web Push infrastructure with VAPID key management, subscription storage, push notification delivery, and REST endpoints for subscription management.

## What Was Built

Created the complete server-side foundation for browser push notifications:

1. **VAPID Key Management** (`vapid.ts`): Loads keys from environment variables, reads from `.planning/.vapid-keys.json`, or generates new keys and persists them. Supports all three VAPID configuration approaches (env vars, file, auto-generation) to handle development and production scenarios.

2. **Subscription Store** (`subscription-store.ts`): In-memory Map-based storage keyed by subscription endpoint URL. Provides add/remove/getAll/size methods for managing browser push subscriptions. Simple implementation suitable for single-instance server (production would use Redis or database).

3. **Push Notification Manager** (`manager.ts`): Wraps web-push library with automatic subscription cleanup. Sends notifications to all registered subscriptions via `sendToAll()`, automatically removing expired subscriptions (404/410 HTTP responses), and logging delivery failures without crashing.

4. **REST Endpoints** (`routes/push.ts`): Express Router factory providing three endpoints:
   - `GET /vapid-public-key` - Returns public key for browser subscription creation
   - `POST /subscribe` - Accepts push subscription from browser, validates fields, stores in subscription store
   - `DELETE /subscribe` - Removes subscription from store

All modules follow ESM conventions with `.js` imports, use `export type` for TypeScript types per `verbatimModuleSyntax`, and integrate cleanly with existing Express Router factory pattern.

## Deviations from Plan

None - plan executed exactly as written.

## Technical Details

**VAPID Key Priority Order:**
1. Environment variables: `VAPID_PUBLIC_KEY`, `VAPID_PRIVATE_KEY`, `VAPID_SUBJECT`
2. Persisted file: `.planning/.vapid-keys.json`
3. Generate new keys via `webpush.generateVAPIDKeys()`, persist to file

**Subscription Store:**
- Uses `Map<string, PushSubscription>` keyed by endpoint URL
- Deduplicates subscriptions automatically (same endpoint overwrites)
- Thread-safe for single-process server (no clustering support)

**Push Delivery:**
- `Promise.allSettled()` ensures all sends attempted even if some fail
- TTL: 3600 seconds (1 hour)
- Urgency: 'high' if `requireInteraction=true`, else 'normal'
- 404/410 responses trigger automatic subscription removal
- Logs warning for other failures without removing subscription

**REST Route Validation:**
- Validates required fields (endpoint, keys.p256dh, keys.auth)
- Returns 400 for invalid/missing fields
- Returns 200 with `{ ok: true }` on success
- Follows Express 5 type patterns (String() cast on params)

## Integration Notes

These modules are ready for wiring but not yet integrated. Plan 04 will:
- Call `loadVAPIDKeys()` in ResponseServer initialization
- Create `SubscriptionStore` and `PushNotificationManager` instances
- Mount push routes at `/api/push` alongside existing `/api` routes
- Inject PushNotificationManager into NotificationManager for actual notification delivery

## Dependencies

**Runtime:**
- `web-push@3.6.7`: Web Push protocol implementation with VAPID support
- Express 5 (existing)
- Node.js fs/path modules (existing)

**Development:**
- `@types/web-push@3.6.4`: TypeScript type definitions

## Verification Results

All verification criteria passed:

- [x] `npx tsc --noEmit` passes with zero errors
- [x] web-push in dependencies, @types/web-push in devDependencies
- [x] `.vapid-keys.json` in .gitignore
- [x] All four new files exist and export documented interfaces
- [x] No circular imports between push modules

## Task Breakdown

| Task | Name | Commit | Duration | Files |
|------|------|--------|----------|-------|
| 1 | Install web-push, create VAPID key manager and subscription store | 09aabd5 | ~60s | vapid.ts, subscription-store.ts, .gitignore, package.json |
| 2 | Create PushNotificationManager and push subscription REST routes | b7691dd | ~60s | manager.ts, routes/push.ts |

## Success Criteria Met

- [x] Server-side push infrastructure compiles and is ready for wiring
- [x] VAPID key generation/loading handles both env var and file-based approaches
- [x] Subscription store provides clean add/remove/getAll interface
- [x] Push routes follow existing Express Router factory pattern
- [x] Expired subscriptions are automatically cleaned up on send failure

## Next Steps

Plan 02 (Client-Side Service Worker) will create the browser-side push subscription handler. Plan 04 (Server Wiring) will integrate these modules into ResponseServer and connect PushNotificationManager to NotificationManager.

## Self-Check: PASSED

**Created Files:**
- FOUND: autopilot/src/server/push/vapid.ts
- FOUND: autopilot/src/server/push/subscription-store.ts
- FOUND: autopilot/src/server/push/manager.ts
- FOUND: autopilot/src/server/routes/push.ts

**Commits:**
- FOUND: 09aabd5
- FOUND: b7691dd

**Packages:**
- FOUND: web-push in dependencies
- FOUND: @types/web-push in devDependencies

**Git Ignore:**
- FOUND: .vapid-keys.json in autopilot/.gitignore

All artifacts verified successfully.
