---
phase: 06.1-add-browser-notifications-to-alert-users-when-needed
plan: 03
subsystem: dashboard/notifications
tags:
  - notifications
  - pwa
  - ui
  - preferences
  - badge-api
dependency_graph:
  requires:
    - 06.1-01 (server-push-infrastructure)
    - 06.1-02 (service-worker)
  provides:
    - notification-preferences-ui
    - push-subscription-management
    - badge-count-display
    - soft-ask-permission-flow
  affects:
    - autopilot/dashboard/src/components/Layout.tsx
tech_stack:
  added: []
  patterns:
    - localStorage for per-type notification preferences with cross-tab sync
    - React hooks for push subscription lifecycle management
    - Soft-ask permission flow (user-initiated, not auto-prompt)
    - Progressive enhancement for Badge API
    - Dropdown UI pattern for notification controls
key_files:
  created:
    - autopilot/dashboard/src/utils/notification-preferences.ts
    - autopilot/dashboard/src/hooks/usePushSubscription.ts
    - autopilot/dashboard/src/hooks/useBadgeCount.ts
    - autopilot/dashboard/src/components/NotificationToggle.tsx
  modified:
    - autopilot/dashboard/src/api/client.ts
    - autopilot/dashboard/src/components/Layout.tsx
decisions:
  - "Action-needed notifications (questions, errors) enabled by default"
  - "Informational notifications (phaseCompleted) disabled by default"
  - "Build-complete notification enabled by default (important milestone)"
  - "Soft-ask permission flow: show 'Enable notifications' link, not auto-prompt"
  - "Permission denied shows help text with browser settings guidance"
  - "Badge API integrated as progressive enhancement (silent fail)"
  - "Per-type preferences persist in localStorage with cross-tab sync"
  - "Dropdown placement after navigation links in header (subtle, non-intrusive)"
metrics:
  duration_seconds: 149
  tasks_completed: 2
  files_created: 4
  files_modified: 2
  commits: 2
  completed_at: "2026-02-24T19:05:46Z"
---

# Phase 06.1 Plan 03: Dashboard Notification UI Summary

Dashboard notification controls with per-type preference toggles, push subscription management, badge count display, and soft-ask permission flow.

## What Was Built

Created the complete dashboard-side notification UI infrastructure:

1. **Notification Preferences Utility** (`notification-preferences.ts`):
   - Interface with four per-type toggles: `questions`, `errors`, `phaseCompleted`, `buildComplete`
   - Default preferences: action-needed notifications ON (questions, errors), informational OFF (phaseCompleted), build-complete ON
   - localStorage persistence with `getDefaultPreferences()`, `loadNotificationPreferences()`, `saveNotificationPreferences()`
   - `useNotificationPreferences()` React hook with cross-tab synchronization via `storage` event
   - Forward-compatible: spreads loaded prefs over defaults to handle new preference types

2. **Push Subscription Hook** (`usePushSubscription.ts`):
   - Manages full push subscription lifecycle: permission request → subscription → server sync → unsubscription
   - Feature detection guards: checks for `serviceWorker` and `PushManager` support
   - On mount: checks existing subscription and syncs to server (idempotent)
   - `subscribe()`: requests permission → fetches VAPID public key → creates push subscription → sends to server
   - `unsubscribe()`: unsubscribes locally → notifies server → clears state
   - `urlBase64ToUint8Array()` helper converts VAPID key from base64url to Uint8Array
   - Returns `{ permission, subscription, loading, subscribe, unsubscribe }`

3. **Badge Count Hook** (`useBadgeCount.ts`):
   - Subscribes to Zustand store questions array
   - Sets browser badge to pending question count via Badge API
   - Progressive enhancement: feature detection with silent fallback
   - Type assertion for `navigator.setAppBadge` and `navigator.clearAppBadge` (not yet in TypeScript DOM types)

4. **NotificationToggle Component** (`NotificationToggle.tsx`):
   - Three UI states based on permission:
     - **Default (first visit)**: Shows "Enable notifications" link (soft-ask approach)
     - **Denied**: Shows "Notifications blocked" with tooltip pointing to browser settings
     - **Granted**: Shows "Notifications" dropdown with per-type toggles and disable-all option
   - Dropdown contains four checkboxes (Questions, Errors, Phase completed, Build complete)
   - Reads from and updates notification preferences via `useNotificationPreferences`
   - "Disable all notifications" link calls `unsubscribe()` and closes dropdown
   - Subtle styling: small text, gray colors, non-intrusive placement

5. **Layout Integration**:
   - Imported and called `useBadgeCount()` at component top level
   - Placed `<NotificationToggle />` in header nav after "Logs" link
   - Badge updates automatically when questions array changes

6. **API Client Functions** (`client.ts`):
   - `fetchVapidPublicKey()`: GET `/api/push/vapid-public-key` → `{ publicKey }`
   - `subscribePush(subscription)`: POST `/api/push/subscribe` with subscription JSON
   - `unsubscribePush(endpoint)`: DELETE `/api/push/subscribe` with `{ endpoint }`

## Deviations from Plan

None - plan executed exactly as written.

## Technical Details

**Permission Flow:**
- First visit: User sees subtle "Enable notifications" link in header
- Click triggers `Notification.requestPermission()` via user interaction (not auto-prompt)
- If granted: subscription created and sent to server
- If denied: help text shown with guidance to enable in browser settings

**Preference Defaults:**
- Questions: TRUE (action-needed)
- Errors: TRUE (action-needed)
- Phase completed: FALSE (informational, per Claude's discretion)
- Build complete: TRUE (important milestone)

**Cross-Tab Sync:**
- `storage` event listener in `useNotificationPreferences` hook
- When localStorage changes in one tab, all tabs reload preferences automatically
- Ensures consistent notification settings across multiple dashboard windows

**Badge API Integration:**
- Feature detection: `if ('setAppBadge' in navigator)`
- Silent failure: `.catch(() => {})` for progressive enhancement
- Updates on every question array change via Zustand store subscription
- Type assertion for TypeScript compatibility (Badge API not yet in DOM types)

**Push Subscription Lifecycle:**
1. Check for existing subscription on mount
2. Sync existing subscription to server (idempotent, handles page refresh)
3. User clicks "Enable notifications" → request permission
4. Fetch VAPID public key from server
5. Create push subscription with `userVisibleOnly: true` and VAPID key
6. Send subscription JSON to server via POST `/api/push/subscribe`
7. User can unsubscribe via "Disable all" link in dropdown

## Verification Results

All verification checks passed:

- [x] `npx tsc --noEmit` compiles without errors
- [x] `npx vite build` produces valid build output (405.63 KiB, 7 precache entries)
- [x] NotificationToggle renders in Layout header after navigation links
- [x] Preferences persist in localStorage
- [x] Push subscription hook makes correct API calls to /api/push/* endpoints
- [x] Badge hook calls navigator.setAppBadge with correct count

## Task Breakdown

| Task | Name | Commit | Duration | Files |
|------|------|--------|----------|-------|
| 1 | Create notification preferences utility and push subscription hook | 24f10c9 | ~75s | notification-preferences.ts, usePushSubscription.ts, client.ts |
| 2 | Create NotificationToggle component, Badge hook, and wire into Layout | a893c86 | ~74s | NotificationToggle.tsx, useBadgeCount.ts, Layout.tsx |

## Success Criteria Met

- [x] Per-type notification toggles work and persist in localStorage (questions, errors, phase-completed, build-complete)
- [x] Soft-ask permission flow on first visit (not aggressive auto-prompt)
- [x] Push subscription sent to server after permission granted
- [x] Denied permission shows help text
- [x] Badge API integrated as progressive enhancement
- [x] Layout header includes notification controls without cluttering UI

## Integration Notes

This plan connects the browser to the server's push infrastructure (Plan 01) via the Service Worker (Plan 02). All three pieces are now in place:

- **Server (Plan 01)**: VAPID keys, subscription store, push notification manager, REST endpoints
- **Service Worker (Plan 02)**: Push event handler, notification click handler, PWA manifest
- **Dashboard UI (Plan 03)**: Permission flow, per-type toggles, subscription management, badge display

**Next step (Plan 04)**: Wire push notification manager into the server's event system to actually send notifications when events occur (questions, errors, phase-completed, build-complete).

## Dependencies

**Used:**
- React hooks (useState, useEffect)
- Zustand store (questions array)
- Browser APIs: Notifications API, Push API, Service Worker API, Badge API
- Plan 01 REST endpoints: `/api/push/vapid-public-key`, `/api/push/subscribe` (POST/DELETE)

**No new packages installed** - all functionality built with existing dependencies and browser APIs.

## Self-Check: PASSED

**Created Files:**
```
✓ FOUND: autopilot/dashboard/src/utils/notification-preferences.ts
✓ FOUND: autopilot/dashboard/src/hooks/usePushSubscription.ts
✓ FOUND: autopilot/dashboard/src/hooks/useBadgeCount.ts
✓ FOUND: autopilot/dashboard/src/components/NotificationToggle.tsx
```

**Modified Files:**
```
✓ FOUND: autopilot/dashboard/src/api/client.ts (added push endpoint functions)
✓ FOUND: autopilot/dashboard/src/components/Layout.tsx (added NotificationToggle and useBadgeCount)
```

**Commits:**
```
✓ FOUND: 24f10c9 (Task 1: notification preferences and push subscription hook)
✓ FOUND: a893c86 (Task 2: NotificationToggle UI and badge hook)
```

**Build Output:**
```
✓ PASSED: npx tsc --noEmit (no errors)
✓ PASSED: npx vite build (405.63 KiB, 7 precache entries)
✓ PASSED: Service Worker build (16.66 KiB)
```

All artifacts verified successfully.

## Next Steps

Plan 04 (06.1-04-PLAN.md) will:
1. Wire push notification manager into ResponseServer initialization
2. Mount push routes at `/api/push` alongside existing API routes
3. Connect push notification manager to NotificationManager for actual event-driven notification delivery
4. Send push notifications on: questions (pending), errors, phase-completed (if enabled), build-complete (if enabled)
5. Respect per-type user preferences when dispatching notifications
