---
phase: 06-notification-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autopilot/src/types/notification.ts
  - autopilot/src/notifications/types.ts
  - autopilot/src/notifications/manager.ts
  - autopilot/src/notifications/adapters/console.ts
  - autopilot/src/notifications/index.ts
  - autopilot/src/notifications/__tests__/manager.test.ts
  - autopilot/src/notifications/__tests__/console.test.ts
autonomous: true

must_haves:
  truths:
    - "NotificationManager dispatches a Notification to all configured adapters simultaneously via Promise.allSettled"
    - "If all non-console adapters fail, console fallback is always attempted as last resort"
    - "Console adapter prints inline colored notification with full question text, options, clickable dashboard URL, and terminal bell for question type only"
    - "Question reminder re-notifies after configurable timeout if question is still unanswered"
    - "Stop notifications include status, summary (phases completed, elapsed time, error if applicable), and next steps"
  artifacts:
    - path: "autopilot/src/types/notification.ts"
      provides: "Updated NotificationAdapter interface with init/send/close lifecycle"
      contains: "init"
    - path: "autopilot/src/notifications/manager.ts"
      provides: "NotificationManager with dispatch, fallback, and reminder timer"
      exports: ["NotificationManager"]
    - path: "autopilot/src/notifications/adapters/console.ts"
      provides: "ConsoleAdapter with inline colored output, bell, URL"
      exports: ["ConsoleAdapter"]
    - path: "autopilot/src/notifications/index.ts"
      provides: "Barrel export for notifications module"
  key_links:
    - from: "autopilot/src/notifications/manager.ts"
      to: "autopilot/src/types/notification.ts"
      via: "import type { Notification, NotificationAdapter }"
      pattern: "import.*NotificationAdapter"
    - from: "autopilot/src/notifications/manager.ts"
      to: "Promise.allSettled"
      via: "parallel adapter dispatch"
      pattern: "Promise\\.allSettled"
    - from: "autopilot/src/notifications/adapters/console.ts"
      to: "ansis"
      via: "colored terminal output"
      pattern: "import ansis"
---

<objective>
Create the notification system foundation: updated types with adapter lifecycle, NotificationManager with parallel dispatch and console fallback, and the ConsoleAdapter as the default zero-dependency notification channel.

Purpose: Establishes the core notification dispatch layer that all other adapters plug into, and the console adapter that ships as the always-on default. This plan delivers a usable notification system even before remote adapters are added.
Output: NotificationManager class, ConsoleAdapter class, updated types, barrel exports, tests.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@autopilot/src/types/notification.ts
@autopilot/src/types/config.ts
@autopilot/src/output/colors.ts
@autopilot/src/output/stream-renderer.ts
@autopilot/src/claude/question-handler.ts
@autopilot/src/claude/types.ts
@autopilot/src/orchestrator/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update notification types and create NotificationManager with dispatch, fallback, and reminders</name>
  <files>
    autopilot/src/types/notification.ts
    autopilot/src/notifications/types.ts
    autopilot/src/notifications/manager.ts
    autopilot/src/notifications/__tests__/manager.test.ts
  </files>
  <action>
**1. Update `autopilot/src/types/notification.ts`:**

Replace the existing stub interface with the full lifecycle-based adapter contract per user decision (class-based with init/send/close):

```typescript
export type NotificationSeverity = 'info' | 'warning' | 'critical';
export type NotificationType = 'question' | 'progress' | 'error' | 'complete';

export interface Notification {
  id: string;
  type: NotificationType;
  title: string;
  body: string;
  severity: NotificationSeverity;
  respondUrl?: string;       // Dashboard URL for question responses
  options?: string[];         // Question option labels
  phase?: number;
  step?: string;
  createdAt: string;
  // Stop notification extras
  summary?: string;           // e.g. "3 of 7 phases completed in 45 min"
  nextSteps?: string;         // e.g. "Run --resume to continue" or "Check verification gaps"
  errorMessage?: string;      // Error details if type is 'error'
}

export interface NotificationAdapter {
  readonly name: string;
  init(): Promise<void>;
  send(notification: Notification): Promise<void>;
  close(): Promise<void>;
}
```

**2. Create `autopilot/src/notifications/types.ts`:**

Internal types for the notifications module. Re-export the shared types and define manager-specific types:

```typescript
export type { Notification, NotificationAdapter, NotificationType, NotificationSeverity } from '../types/notification.js';

export interface NotificationManagerOptions {
  port: number;                    // For building dashboard URLs
  questionReminderMs?: number;     // Default: 300_000 (5 min)
  stopSpinner?: () => void;        // Callback to stop ora spinner before console writes
}
```

**3. Create `autopilot/src/notifications/manager.ts`:**

NotificationManager class that:
- Accepts adapters via `addAdapter(adapter)` before `init()`
- `init()` calls `adapter.init()` on each adapter; if init() throws, log warning and remove that adapter (do NOT crash startup per research Pitfall 5)
- `notify(notification)` dispatches to all adapters via `Promise.allSettled()`. If ALL non-console adapters reject AND a ConsoleAdapter is present, the console adapter is guaranteed to have been attempted (it's always in the adapter list). If ALL adapters fail (including console), log error but do not throw.
- `startReminder(questionId, notification)` sets a `setTimeout` for `questionReminderMs` (default 5 min). When it fires, call `notify()` again with the same notification. Use `timer.unref()` to prevent blocking Node exit (same pattern as `createTimeout` in claude module).
- `cancelReminder(questionId)` clears the timeout for a specific question (wire to `question:answered` event to prevent reminder leaking -- research Pitfall 4).
- `close()` cancels all reminders and calls `adapter.close()` on each adapter.

The manager stores adapters in an array. Console adapter is always added first (it's the fallback). The fallback logic: after `Promise.allSettled`, check if ALL results are rejected. If so, and if the console adapter was NOT already in the list (edge case), create a temporary ConsoleAdapter and call send(). In practice, console is always present, so the fallback is automatic.

Import `randomUUID` from `node:crypto` for notification IDs if not provided.

**4. Create `autopilot/src/notifications/__tests__/manager.test.ts`:**

Test cases:
- `notify() calls send() on all adapters`: Create 2 mock adapters, call notify(), verify both received the notification.
- `notify() uses Promise.allSettled (one failure doesn't block others)`: First adapter rejects, second should still receive.
- `console fallback attempted when all fail`: Register only a failing mock + a console adapter. Verify console adapter's send() was called even though other failed.
- `init() removes adapters that fail to initialize`: Mock adapter init() throws. After manager.init(), notify() should NOT call that adapter.
- `startReminder() re-notifies after timeout`: Use `vi.useFakeTimers()`. Start reminder, advance time by reminderMs, verify notify was called again.
- `cancelReminder() prevents re-notification`: Start reminder, cancel it, advance time, verify no second notify.
- `close() clears reminders and calls adapter.close()`: Start reminder, call close(), verify timer cleared and adapter.close() called.
  </action>
  <verify>
Run `cd C:/GitHub/GetShitDone/get-shit-done/autopilot && npx vitest run src/notifications/__tests__/manager.test.ts` -- all tests pass.
Run `npx tsc --noEmit` -- no type errors.
  </verify>
  <done>
NotificationManager dispatches to multiple adapters via Promise.allSettled, handles init failures gracefully, supports question reminders with cancel, and has 7+ passing tests. NotificationAdapter interface has init/send/close lifecycle per user decision.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ConsoleAdapter with inline colored output and barrel exports</name>
  <files>
    autopilot/src/notifications/adapters/console.ts
    autopilot/src/notifications/__tests__/console.test.ts
    autopilot/src/notifications/index.ts
  </files>
  <action>
**1. Create `autopilot/src/notifications/adapters/console.ts`:**

ConsoleAdapter implements NotificationAdapter. Per user locked decisions:
- **Inline with normal output flow** -- colored line, NOT a box/banner
- **Question notifications**: Print full question text and all options, include clickable dashboard URL (`http://localhost:{port}/questions/{id}`), terminal bell character (`\a`) appended
- **Stop notifications**: Print status, summary, next steps -- no bell
- **No bell for non-question types**

Implementation:
- Constructor accepts `{ port: number, stopSpinner?: () => void }`. If stopSpinner callback provided, call it before every write (prevents ora garbled output per research Pitfall 1).
- `name` property returns `'console'`
- `init()` is a no-op (returns resolved promise)
- `close()` is a no-op
- `send(notification)` writes to `process.stdout`:

For `type === 'question'`:
```
\a[?] Phase 3: What approach for authentication? (http://localhost:3847/questions/abc-123)
    Option 1: JWT tokens
    Option 2: Session cookies
```
Use ansis colors: `palette.warning` (yellow) for the `[?]` prefix, `palette.text` (white) for body, `palette.dim` for URL and options.

For `type === 'error'`:
```
[!] Autopilot stopped: Command failed after retry (Phase 3, execute)
    Summary: 2 of 7 phases completed in 12 min
    Next: Run `gsd-autopilot --resume` to retry from phase 3
```
Use `palette.error` (bold red) for `[!]` prefix.

For `type === 'complete'`:
```
[v] Build complete: 7 of 7 phases completed in 2.3 hours
    Next: Review output in .planning/ directory
```
Use `palette.success` (green) for `[v]` prefix.

For `type === 'progress'` (currently unused per locked decisions, but implement for completeness):
```
[i] Phase 3 discuss complete
```
Use `palette.dim` for `[i]` prefix.

The adapter writes to a `WritableOutput` interface (same pattern as StreamRenderer) for testability. Default: `process.stdout`. Accept optional output param in constructor.

**2. Create `autopilot/src/notifications/__tests__/console.test.ts`:**

Test using a mock WritableOutput (array-backed string collector):
- `question notification includes full question text and options`
- `question notification includes clickable URL with correct port and question ID`
- `question notification includes terminal bell character \\a`
- `stop/error notification does NOT include bell`
- `complete notification uses green prefix`
- `stopSpinner callback is called before write`
- `init() and close() resolve without error`

**3. Create `autopilot/src/notifications/index.ts`:**

Barrel exports:
```typescript
export { NotificationManager } from './manager.js';
export { ConsoleAdapter } from './adapters/console.js';
export type { NotificationManagerOptions } from './types.js';
```
  </action>
  <verify>
Run `cd C:/GitHub/GetShitDone/get-shit-done/autopilot && npx vitest run src/notifications/__tests__/console.test.ts` -- all tests pass.
Run `npx tsc --noEmit` -- no type errors.
  </verify>
  <done>
ConsoleAdapter prints inline colored notifications with question text, options, clickable dashboard URL, and terminal bell for questions only. Barrel exports established. 7+ console adapter tests passing.
  </done>
</task>

</tasks>

<verification>
- `npx vitest run src/notifications/` -- all notification tests pass
- `npx tsc --noEmit` -- full project compiles
- NotificationManager can be imported from `./notifications/index.js`
- ConsoleAdapter can be imported from `./notifications/index.js`
</verification>

<success_criteria>
- NotificationManager dispatches to N adapters via Promise.allSettled
- Failed adapter init removes adapter without crashing
- Console fallback always attempted
- Question reminders fire after timeout, cancelable
- ConsoleAdapter formats question/error/complete notifications per locked decisions
- Terminal bell only on question notifications
- All tests pass, TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/06-notification-system/06-01-SUMMARY.md`
</output>
