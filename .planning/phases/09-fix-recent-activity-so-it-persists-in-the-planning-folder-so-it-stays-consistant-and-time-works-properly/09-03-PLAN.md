---
phase: 09-fix-recent-activity-persistence
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - autopilot/dashboard/src/types/index.ts
  - autopilot/dashboard/src/api/client.ts
  - autopilot/dashboard/src/store/index.ts
  - autopilot/dashboard/src/hooks/useSSE.ts
  - autopilot/dashboard/src/components/ActivityFeed.tsx
  - autopilot/dashboard/src/pages/Overview.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard loads persisted activities from /api/activities on connect/reconnect (not client-created)"
    - "Activities show last 20 entries with a Load more button for older entries"
    - "Timestamps show relative time for < 24h and absolute date for >= 24h"
    - "Timestamp display updates live every 30 seconds"
    - "Error activities have bold text and red background tint"
    - "Activity types use colored dots: orange for questions, green for success, red for errors, blue for progress"
    - "SSE events update activities from server but do NOT create client-side activities"
    - "Answered questions show checkmark indicator in the activity feed"
  artifacts:
    - path: "autopilot/dashboard/src/types/index.ts"
      provides: "Updated ActivityItem type with all 9 types and metadata field"
      contains: "step-started"
    - path: "autopilot/dashboard/src/api/client.ts"
      provides: "fetchActivities() function for GET /api/activities"
      exports: ["fetchActivities"]
    - path: "autopilot/dashboard/src/hooks/useSSE.ts"
      provides: "Rehydrate includes activities from REST; SSE handlers no longer create client-side activities"
      contains: "fetchActivities"
    - path: "autopilot/dashboard/src/components/ActivityFeed.tsx"
      provides: "Enhanced component with Load more, 30s timestamp refresh, error styling, colored dots for all types"
      contains: "Load more"
    - path: "autopilot/dashboard/src/store/index.ts"
      provides: "setActivities action for full replacement (not just addActivity)"
      contains: "setActivities"
  key_links:
    - from: "autopilot/dashboard/src/hooks/useSSE.ts"
      to: "/api/activities"
      via: "fetchActivities() in rehydrate()"
      pattern: "fetchActivities"
    - from: "autopilot/dashboard/src/components/ActivityFeed.tsx"
      to: "formatTimestamp"
      via: "30s interval re-render with relative/absolute time logic"
      pattern: "setInterval.*30"
    - from: "autopilot/dashboard/src/pages/Overview.tsx"
      to: "ActivityFeed"
      via: "passes full activities array (component handles pagination)"
      pattern: "ActivityFeed.*activities"
---

<objective>
Update the dashboard to load persisted activities from the server, remove client-side activity creation, enhance the ActivityFeed with proper time formatting, Load more pagination, and visual styling per locked decisions.

Purpose: Complete the activity persistence fix by making the dashboard consume server-persisted activities instead of creating them client-side. Fix timestamp display with relative/absolute time switching at 24h. Add visual distinction for activity types per user decisions.

Output: Dashboard loads activities from REST, SSE refreshes from server, ActivityFeed shows proper timestamps with Load more button and styled entries.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-fix-recent-activity-so-it-persists-in-the-planning-folder-so-it-stays-consistant-and-time-works-properly/09-01-SUMMARY.md
@autopilot/dashboard/src/types/index.ts
@autopilot/dashboard/src/api/client.ts
@autopilot/dashboard/src/store/index.ts
@autopilot/dashboard/src/hooks/useSSE.ts
@autopilot/dashboard/src/components/ActivityFeed.tsx
@autopilot/dashboard/src/pages/Overview.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update dashboard types, API client, and store for server-sourced activities</name>
  <files>autopilot/dashboard/src/types/index.ts, autopilot/dashboard/src/api/client.ts, autopilot/dashboard/src/store/index.ts</files>
  <action>
**autopilot/dashboard/src/types/index.ts:**

Update the ActivityItem type to include all 9 activity types and add metadata field (mirroring the server's ActivityEntry type):
```typescript
export type ActivityItem = {
  type:
    | 'phase-started'
    | 'phase-completed'
    | 'phase-failed'
    | 'step-started'
    | 'step-completed'
    | 'question-pending'
    | 'question-answered'
    | 'error'
    | 'build-complete';
  message: string;
  timestamp: string;
  metadata?: {
    phase?: number;
    step?: string;
    questionId?: string;
    [key: string]: unknown;
  };
};
```

**autopilot/dashboard/src/api/client.ts:**

1. Add ActivityItem import at the top.

2. Add ActivitiesResponse interface:
```typescript
export interface ActivitiesResponse {
  activities: ActivityItem[];
}
```

3. Add fetchActivities function:
```typescript
export async function fetchActivities(): Promise<ActivitiesResponse> {
  const res = await fetch('/api/activities');
  if (!res.ok) {
    throw new Error(`fetchActivities failed: ${String(res.status)}`);
  }
  return res.json() as Promise<ActivitiesResponse>;
}
```

**autopilot/dashboard/src/store/index.ts:**

1. Add `setActivities` action to the DashboardState interface:
```typescript
setActivities: (activities: ActivityItem[]) => void;
```

2. Implement in the create call:
```typescript
setActivities: (activities) => set({ activities }),
```

Keep the existing `addActivity` action (still used for SSE-triggered single additions). But also keep `setActivities` for full replacement during rehydration.
  </action>
  <verify>
Run `npx tsc --noEmit` from autopilot/dashboard/ directory. Verify:
- ActivityItem type has all 9 activity types including 'step-started', 'step-completed', 'phase-failed'
- fetchActivities function exists in client.ts
- setActivities action exists in store
  </verify>
  <done>
Dashboard types mirror server ActivityEntry type with all 9 activity types and metadata. API client can fetch persisted activities. Store supports both full replacement (setActivities) and single addition (addActivity).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update useSSE to load activities from REST and remove client-side creation</name>
  <files>autopilot/dashboard/src/hooks/useSSE.ts</files>
  <action>
**Modify rehydrate():**

1. Import fetchActivities:
```typescript
import { fetchStatus, fetchPhases, fetchQuestions, fetchActivities } from '../api/client.js';
```

2. Remove the `ActivityItem` import (no longer needed since we don't create activities here).

3. Update rehydrate to include activities:
```typescript
async function rehydrate(): Promise<void> {
  const store = useDashboardStore.getState();
  try {
    const [statusRes, phasesRes, questionsRes, activitiesRes] = await Promise.all([
      fetchStatus(),
      fetchPhases(),
      fetchQuestions(),
      fetchActivities(),
    ]);
    store.setStatus({ ... });  // existing
    store.setAutopilotAlive(statusRes.alive);
    store.setPhases(phasesRes.phases);
    store.setQuestions(questionsRes.questions);
    store.setActivities(activitiesRes.activities);  // NEW: full replacement
  } catch {
    // Rehydration failure is non-fatal
  }
}
```

**Remove client-side activity creation from ALL SSE event handlers:**

For phase-started: Remove the `const activity: ActivityItem = { ... }` block and `addActivity(activity)` call. Keep the fetchStatus/fetchPhases refresh.

For phase-completed: Same -- remove activity creation, keep fetchStatus/fetchPhases refresh. ALSO add fetchActivities to the refresh so the feed updates when a phase completes:
```typescript
es.addEventListener('phase-completed', (e: MessageEvent) => {
  void Promise.all([fetchStatus(), fetchPhases(), fetchActivities()]).then(([s, p, a]) => {
    const st = useDashboardStore.getState();
    st.setStatus({ ... });
    st.setAutopilotAlive(s.alive);
    st.setPhases(p.phases);
    st.setActivities(a.activities);
  });
});
```

For phase-started: Similarly, add fetchActivities to the refresh:
```typescript
es.addEventListener('phase-started', (e: MessageEvent) => {
  void Promise.all([fetchStatus(), fetchPhases(), fetchActivities()]).then(([s, p, a]) => {
    const st = useDashboardStore.getState();
    st.setStatus({ ... });
    st.setAutopilotAlive(s.alive);
    st.setPhases(p.phases);
    st.setActivities(a.activities);
  });
});
```
The event data is no longer needed for activity creation -- the `(e: MessageEvent)` param can be removed or kept unused.

For question-pending: Remove activity creation. Keep fetchQuestions refresh. ADD fetchActivities:
```typescript
es.addEventListener('question-pending', () => {
  void Promise.all([fetchQuestions(), fetchActivities()]).then(([q, a]) => {
    useDashboardStore.getState().setQuestions(q.questions);
    useDashboardStore.getState().setActivities(a.activities);
  });
});
```

For question-answered: Add fetchActivities alongside fetchQuestions.

For error: Remove the client-side activity creation. Add a fetchActivities refresh:
```typescript
es.addEventListener('error', () => {
  void fetchActivities().then((a) => {
    useDashboardStore.getState().setActivities(a.activities);
  });
});
```

For build-complete: Remove client-side activity creation. Add fetchActivities to the existing fetchStatus refresh:
```typescript
es.addEventListener('build-complete', () => {
  void Promise.all([fetchStatus(), fetchActivities()]).then(([s, a]) => {
    const st = useDashboardStore.getState();
    st.setStatus({ ... });
    st.setAutopilotAlive(s.alive);
    st.setActivities(a.activities);
  });
});
```

For step-completed: Add fetchActivities to the existing refresh:
```typescript
es.addEventListener('step-completed', () => {
  void Promise.all([fetchStatus(), fetchPhases(), fetchActivities()]).then(([s, p, a]) => {
    const st = useDashboardStore.getState();
    st.setStatus({ ... });
    st.setAutopilotAlive(s.alive);
    st.setPhases(p.phases);
    st.setActivities(a.activities);
  });
});
```

For the polling timer: Add fetchActivities to the 3-second poll:
```typescript
const pollTimer = setInterval(() => {
  void Promise.all([fetchStatus(), fetchPhases(), fetchQuestions(), fetchActivities()]).then(([s, p, q, a]) => {
    const st = useDashboardStore.getState();
    st.setStatus({ ... });
    st.setAutopilotAlive(s.alive);
    st.setPhases(p.phases);
    st.setQuestions(q.questions);
    st.setActivities(a.activities);
  }).catch(() => { /* ignore poll failures */ });
}, 3000);
```

**Key principle:** Activities are now ALWAYS loaded from the server via fetchActivities(). The SSE handlers trigger a refresh, not create activities. This eliminates client timestamp issues and ensures activities survive page reloads and reconnects.
  </action>
  <verify>
Run `npx tsc --noEmit` from autopilot/dashboard/ directory. Grep useSSE.ts for:
- No occurrences of `new Date().toISOString()` (all client timestamps removed)
- No occurrences of `addActivity` (no client-side activity creation)
- fetchActivities is called in rehydrate and in SSE event handlers
- setActivities is used instead of addActivity
  </verify>
  <done>
useSSE.ts loads activities exclusively from server via fetchActivities(). All client-side activity creation with client timestamps is removed. Activities refresh on every SSE event and during 3-second polling. Rehydrate fetches full activity list on connect/reconnect.
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance ActivityFeed with time formatting, Load more, and visual styling</name>
  <files>autopilot/dashboard/src/components/ActivityFeed.tsx, autopilot/dashboard/src/pages/Overview.tsx</files>
  <action>
**autopilot/dashboard/src/components/ActivityFeed.tsx:**

Complete rewrite of the component to implement all locked decisions:

1. **Replace timeAgo with formatTimestamp:**
```typescript
function formatTimestamp(isoString: string, now: number): string {
  const then = new Date(isoString).getTime();
  const diffSeconds = Math.floor((now - then) / 1000);

  if (diffSeconds < 0 || isNaN(diffSeconds)) return 'just now';

  const diffHours = Math.floor(diffSeconds / 3600);

  // Absolute date for >= 24h (per locked decision)
  if (diffHours >= 24) {
    return new Date(isoString).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
    }); // e.g., "Feb 24, 2:30 PM"
  }

  // Relative time for < 24h
  if (diffSeconds < 10) return 'just now';
  if (diffSeconds < 60) return `${String(diffSeconds)}s ago`;
  const diffMinutes = Math.floor(diffSeconds / 60);
  if (diffMinutes < 60) return `${String(diffMinutes)} minutes ago`;
  return `${String(diffHours)} hours ago`;
}
```

2. **Update TYPE_COLORS to include all 9 types with locked color scheme:**
```typescript
const TYPE_COLORS: Record<ActivityItem['type'], string> = {
  'phase-started': 'bg-blue-500',      // blue for progress
  'phase-completed': 'bg-green-500',   // green for success
  'phase-failed': 'bg-red-500',        // red for errors
  'step-started': 'bg-blue-400',       // blue for progress
  'step-completed': 'bg-blue-400',     // blue for progress
  'question-pending': 'bg-orange-500', // orange for questions (was amber, now orange per locked decision)
  'question-answered': 'bg-green-400', // green for success (answered)
  'error': 'bg-red-500',              // red for errors
  'build-complete': 'bg-green-600',    // green for success
};
```

3. **Add 30-second timestamp refresh using useState + useEffect:**
```typescript
import { useState, useEffect } from 'react';
import type { ActivityItem } from '../types/index.js';

// ... inside component:
const [currentTime, setCurrentTime] = useState(Date.now());

useEffect(() => {
  const timer = setInterval(() => {
    setCurrentTime(Date.now());
  }, 30_000);
  return () => clearInterval(timer);
}, []);
```

4. **Add Load more pagination:**
```typescript
const [visibleCount, setVisibleCount] = useState(20);
const loadMore = () => setVisibleCount((prev) => prev + 20);
const visibleActivities = activities.slice(0, visibleCount);
const hasMore = visibleCount < activities.length;
```

5. **Error activity styling:** Error activities get bold text + red background tint:
```typescript
const isError = activity.type === 'error' || activity.type === 'phase-failed';
// In JSX:
<div className={`flex items-start gap-3 py-2 ${isError ? 'bg-red-50 rounded px-2 -mx-2' : ''}`}>
  ...
  <p className={`text-sm truncate ${isError ? 'text-red-700 font-bold' : 'text-gray-700'}`}>
    {activity.message}
  </p>
</div>
```

6. **Answered question checkmark indicator:**
For question-answered type, prepend a checkmark:
```typescript
const isAnswered = activity.type === 'question-answered';
// In message display:
<p className="text-sm text-gray-700 truncate">
  {isAnswered && <span className="text-green-600 mr-1">&#10003;</span>}
  {activity.message}
</p>
```

7. **Load more button at bottom:**
```typescript
{hasMore && (
  <button
    onClick={loadMore}
    className="w-full py-2 text-sm text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded transition-colors"
  >
    Load more
  </button>
)}
```

No tooltip on hover -- just the relative/absolute time displayed (per locked decision: "No tooltip on hover").

**autopilot/dashboard/src/pages/Overview.tsx:**

Update the ActivityFeed call to pass the full activities array instead of slicing to 10. The component handles its own pagination now:
```typescript
<ActivityFeed activities={activities} />
```
Remove the `.slice(0, 10)` -- the component internally shows 20 with "Load more".
  </action>
  <verify>
Run `npx tsc --noEmit` from autopilot/dashboard/ directory. Verify in ActivityFeed.tsx:
- formatTimestamp function has 24h threshold check
- 30_000 ms setInterval for timestamp refresh
- "Load more" button rendered conditionally
- Error entries have 'bg-red-50' and 'font-bold' classes
- Checkmark (&#10003;) shown for question-answered type
- Overview.tsx no longer slices activities to 10
  </verify>
  <done>
ActivityFeed shows relative time for < 24h and absolute date for >= 24h, refreshes every 30s. Shows 20 entries with "Load more" button. Error activities have bold text + red background tint. Answered questions show checkmark. All 9 activity types have appropriate colored dots (orange=questions, green=success, red=errors, blue=progress). Overview passes full activities array.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes from autopilot/dashboard/ directory
2. No `new Date().toISOString()` calls in useSSE.ts (client timestamps eliminated)
3. No `addActivity` calls in useSSE.ts (activities come from server)
4. fetchActivities() called in rehydrate and all SSE event handlers
5. ActivityFeed has formatTimestamp with 24h threshold
6. 30-second interval for live timestamp updates
7. "Load more" button visible when activities > 20
8. Error entries styled with bold + red background
9. question-answered entries show checkmark indicator
10. ActivityItem type has all 9 types including step-started, step-completed, phase-failed
</verification>

<success_criteria>
- Dashboard loads activities from server, not created client-side
- Timestamps use relative time < 24h, absolute date >= 24h
- Timestamps update live every 30 seconds
- Last 20 shown with Load more for older entries
- Error activities visually prominent (bold + red tint)
- Answered questions show checkmark indicator
- Colored dots match locked decision (orange/green/red/blue)
- No client-side activity creation remains in useSSE.ts
</success_criteria>

<output>
After completion, create `.planning/phases/09-fix-recent-activity-so-it-persists-in-the-planning-folder-so-it-stays-consistant-and-time-works-properly/09-03-SUMMARY.md`
</output>
