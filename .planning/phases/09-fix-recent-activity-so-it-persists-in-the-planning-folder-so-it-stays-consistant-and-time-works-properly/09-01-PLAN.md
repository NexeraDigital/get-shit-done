---
phase: 09-fix-recent-activity-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autopilot/src/activity/types.ts
  - autopilot/src/activity/index.ts
  - autopilot/src/server/routes/api.ts
autonomous: true

must_haves:
  truths:
    - "ActivityStore persists activities to .planning/autopilot-activity.json with atomic writes"
    - "ActivityStore restores existing activities from disk on startup (cumulative across runs)"
    - "GET /api/activities returns all persisted activities as JSON"
    - "Activities are stored newest-first and include server-generated ISO timestamps"
  artifacts:
    - path: "autopilot/src/activity/types.ts"
      provides: "ActivityEntry type definition with all 9 activity types"
      contains: "ActivityEntry"
    - path: "autopilot/src/activity/index.ts"
      provides: "ActivityStore class with restore/addActivity/getRecent/getAll/persist"
      exports: ["ActivityStore"]
    - path: "autopilot/src/server/routes/api.ts"
      provides: "GET /api/activities endpoint"
      contains: "activities"
  key_links:
    - from: "autopilot/src/activity/index.ts"
      to: "autopilot/src/activity/types.ts"
      via: "import ActivityEntry type"
      pattern: "import.*ActivityEntry.*types"
    - from: "autopilot/src/server/routes/api.ts"
      to: "ActivityStore"
      via: "ActivityProvider interface injected into route factory"
      pattern: "activityProvider"
---

<objective>
Create the ActivityStore persistence class and REST endpoint for the activity feed.

Purpose: Establish the server-side foundation for activity persistence so activities survive restarts and can be loaded by the dashboard. This replaces the current client-side activity creation approach.

Output: ActivityEntry type, ActivityStore class with atomic file persistence, and GET /api/activities REST endpoint.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@autopilot/src/state/index.ts
@autopilot/src/server/routes/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ActivityEntry type and ActivityStore persistence class</name>
  <files>autopilot/src/activity/types.ts, autopilot/src/activity/index.ts</files>
  <action>
Create two new files in `autopilot/src/activity/`:

**types.ts** - Define the ActivityEntry type:
```typescript
export type ActivityEntry = {
  type:
    | 'phase-started'
    | 'phase-completed'
    | 'phase-failed'
    | 'step-started'
    | 'step-completed'
    | 'question-pending'
    | 'question-answered'
    | 'error'
    | 'build-complete';
  message: string;
  timestamp: string; // ISO 8601, server-generated
  metadata?: {
    phase?: number;
    step?: string;
    questionId?: string;
    [key: string]: unknown;
  };
};
```
Use `export type` (consistent with verbatimModuleSyntax decision [01-01]).

**index.ts** - Create ActivityStore class following the StateStore pattern:
- Constructor takes `projectDir: string`, computes file path as `join(projectDir, '.planning', 'autopilot-activity.json')`
- `async restore(): Promise<void>` - Reads and parses the JSON file. On ENOENT or parse error, starts with empty array (logs warning but does NOT throw -- activity persistence is non-critical per research recommendation)
- `async addActivity(entry: ActivityEntry): Promise<void>` - Prepends entry to array (newest-first) and persists. Wrap persist in try-catch -- log error but don't throw (non-critical path per research pitfall 2)
- `getRecent(limit = 50): ActivityEntry[]` - Returns first N entries (for SSE initial burst)
- `getAll(): ActivityEntry[]` - Returns full array (for REST endpoint)
- `private async persist(): Promise<void>` - Uses `write-file-atomic` for atomic writes (same as StateStore). JSON format: `{ activities: ActivityEntry[] }` with 2-space indent

Import write-file-atomic (already a dependency). Import ActivityEntry from `./types.js`.

Also add a `truncateText(text: string, maxLength = 60): string` exported utility function for truncating question text at word boundaries:
- If text.length <= maxLength, return as-is
- Find last space before maxLength. If lastSpace > maxLength * 0.7, truncate there; otherwise truncate at maxLength
- Append "..." to truncated result
  </action>
  <verify>
Run `npx tsc --noEmit` from autopilot/ directory -- no type errors. Verify the files exist and export correctly:
- `autopilot/src/activity/types.ts` exports ActivityEntry
- `autopilot/src/activity/index.ts` exports ActivityStore and truncateText
  </verify>
  <done>
ActivityStore class exists with restore/addActivity/getRecent/getAll methods. Uses write-file-atomic for atomic persistence. ActivityEntry type covers all 9 activity types. truncateText utility handles word-boundary truncation at 60 chars.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GET /api/activities endpoint and ActivityProvider interface</name>
  <files>autopilot/src/server/routes/api.ts</files>
  <action>
Modify `autopilot/src/server/routes/api.ts` to add the activities endpoint:

1. Add a new `ActivityProvider` interface:
```typescript
/** Provides access to persisted activity entries */
export interface ActivityProvider {
  getAll(): { type: string; message: string; timestamp: string; metadata?: Record<string, unknown> }[];
}
```

2. Add `activityProvider?: ActivityProvider` to the `ApiRouteDeps` interface (optional so existing callers don't break).

3. Add a new route inside `createApiRoutes()`:
```typescript
router.get('/activities', (_req: Request, res: Response) => {
  if (!activityProvider) {
    res.json({ activities: [] });
    return;
  }
  const activities = activityProvider.getAll();
  res.json({ activities });
});
```

Destructure `activityProvider` from deps at the top of createApiRoutes alongside the existing destructuring.

The endpoint returns `{ activities: ActivityEntry[] }` -- the full cumulative history. The dashboard handles pagination client-side (show 20, "Load more" button).
  </action>
  <verify>
Run `npx tsc --noEmit` from autopilot/ directory. Verify the route is added by grepping for `'/activities'` in the file. Confirm existing endpoints still compile (no breaking changes to ApiRouteDeps since activityProvider is optional).
  </verify>
  <done>
GET /api/activities endpoint returns all persisted activities as `{ activities: ActivityEntry[] }`. ActivityProvider interface is exported for dependency injection. Existing callers unaffected (field is optional).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors from autopilot/ directory
2. autopilot/src/activity/types.ts exports ActivityEntry type with all 9 activity types
3. autopilot/src/activity/index.ts exports ActivityStore class and truncateText function
4. autopilot/src/server/routes/api.ts has GET /activities route and exports ActivityProvider interface
5. ActivityStore uses write-file-atomic for persistence (grep for 'write-file-atomic')
6. ActivityStore.addActivity does NOT throw on persist failure (try-catch wrapping persist)
</verification>

<success_criteria>
- ActivityStore class persists to .planning/autopilot-activity.json with atomic writes
- REST endpoint serves all activities for dashboard consumption
- No new dependencies needed (write-file-atomic already in project)
- Type compiles cleanly with strict TypeScript
</success_criteria>

<output>
After completion, create `.planning/phases/09-fix-recent-activity-so-it-persists-in-the-planning-folder-so-it-stays-consistant-and-time-works-properly/09-01-SUMMARY.md`
</output>
