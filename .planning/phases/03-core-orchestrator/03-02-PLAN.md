---
phase: 03-core-orchestrator
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - autopilot/src/orchestrator/discuss-handler.ts
  - autopilot/src/orchestrator/gap-detector.ts
  - autopilot/src/orchestrator/__tests__/discuss-handler.test.ts
  - autopilot/src/orchestrator/__tests__/gap-detector.test.ts
autonomous: true

must_haves:
  truths:
    - "generateSkipDiscussContext produces valid CONTEXT.md with Claude's Discretion sections for a given phase"
    - "generateSkipDiscussContext includes phase number, name, and current date in the output"
    - "checkForGaps returns true when VERIFICATION.md contains gap indicators"
    - "checkForGaps returns false when VERIFICATION.md contains passed indicators"
    - "checkForGaps returns false when no verification file exists (assume passed)"
    - "parsePhaseRange parses 'N' into { start: N, end: N } and 'N-M' into { start: N, end: M }"
    - "parsePhaseRange throws on invalid formats and when start > end"
  artifacts:
    - path: "autopilot/src/orchestrator/discuss-handler.ts"
      provides: "generateSkipDiscussContext function and discuss-phase helpers"
      exports: ["generateSkipDiscussContext"]
      min_lines: 30
    - path: "autopilot/src/orchestrator/gap-detector.ts"
      provides: "checkForGaps and parsePhaseRange functions"
      exports: ["checkForGaps", "parsePhaseRange"]
      min_lines: 40
    - path: "autopilot/src/orchestrator/__tests__/discuss-handler.test.ts"
      provides: "TDD tests for discuss-handler"
      min_lines: 40
    - path: "autopilot/src/orchestrator/__tests__/gap-detector.test.ts"
      provides: "TDD tests for gap-detector and parsePhaseRange"
      min_lines: 60
  key_links:
    - from: "autopilot/src/orchestrator/discuss-handler.ts"
      to: "node:fs/promises"
      via: "writes CONTEXT.md file"
      pattern: "writeFile"
    - from: "autopilot/src/orchestrator/gap-detector.ts"
      to: "node:fs/promises"
      via: "reads VERIFICATION.md and UAT.md files"
      pattern: "readFile"
---

<objective>
Build the discuss-phase handler and gap detector using TDD -- two pure logic modules the orchestrator needs for discuss-phase skipping (DISC-04) and gap detection loops (ORCH-05).

Purpose: The discuss-handler generates CONTEXT.md when --skip-discuss is set, enabling the orchestrator to skip human input collection while still producing the file GSD plan-phase expects. The gap detector checks verification output files for pass/fail indicators and supports the bounded gap closure loop. parsePhaseRange supports CLI-09 (--phases flag). All three are pure functions with filesystem I/O, testable independently of the Orchestrator class.

Output: Two fully tested utility modules ready for integration into the Orchestrator in Plan 03.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-core-orchestrator/03-RESEARCH.md
@autopilot/src/types/state.ts
</context>

<feature>
  <name>Feature 1: Discuss-Phase Handler</name>
  <files>autopilot/src/orchestrator/discuss-handler.ts, autopilot/src/orchestrator/__tests__/discuss-handler.test.ts</files>
  <behavior>
    generateSkipDiscussContext produces a well-formatted CONTEXT.md string for a phase, marking all decisions as "Claude's Discretion" per DISC-04.

    Test cases (input -> expected output):

    1. generateSkipDiscussContext({ number: 3, name: 'Core Orchestrator' }) -> output contains "# Phase 3: Core Orchestrator - Context"
    2. Output contains today's date in YYYY-MM-DD format in the Gathered field
    3. Output contains "Claude's Discretion" section with skip-discuss explanation
    4. Output contains "--skip-discuss" reference explaining why decisions are deferred
    5. Output contains phase slug footer (e.g., "03-core-orchestrator")
    6. Output contains empty Deferred Ideas section
    7. writeSkipDiscussContext writes the file to the correct phase directory path

    The output format should match the GSD CONTEXT.md template structure with `<domain>`, `<decisions>`, `<specifics>`, `<deferred>` sections (as shown in research code examples).
  </behavior>
  <implementation>
    Create `src/orchestrator/discuss-handler.ts`:

    ```typescript
    import { writeFile, mkdir } from 'node:fs/promises';
    import { join, dirname } from 'node:path';

    export interface PhaseInfo {
      number: number;
      name: string;
    }

    export function generateSkipDiscussContext(phase: PhaseInfo): string
    export async function writeSkipDiscussContext(projectDir: string, phase: PhaseInfo): Promise<string>
    ```

    `generateSkipDiscussContext(phase)`:
    - Builds a CONTEXT.md string following the GSD template format from 03-RESEARCH.md
    - Includes: phase number, phase name, current date, "Claude's Discretion" in decisions
    - Returns the string (pure function, no I/O)

    `writeSkipDiscussContext(projectDir, phase)`:
    - Calls generateSkipDiscussContext to get content
    - Computes path: `join(projectDir, '.planning', 'phases', `${padded}-${slug}`, `${padded}-CONTEXT.md`)`
    - Creates directory if needed, writes file
    - Returns the file path written

    CRITICAL: The phase slug must be derived consistently -- lowercase, hyphens for spaces/special chars. Match the existing pattern in `.planning/phases/` (e.g., "03-core-orchestrator").
  </implementation>
</feature>

<feature>
  <name>Feature 2: Gap Detector and Phase Range Parser</name>
  <files>autopilot/src/orchestrator/gap-detector.ts, autopilot/src/orchestrator/__tests__/gap-detector.test.ts</files>
  <behavior>
    checkForGaps reads verification output files and determines if gaps exist. parsePhaseRange parses the --phases CLI flag value.

    Test cases for checkForGaps:

    1. VERIFICATION.md contains "gaps_found" -> returns true
    2. VERIFICATION.md contains "GAPS_FOUND" -> returns true
    3. VERIFICATION.md contains "passed" -> returns false
    4. VERIFICATION.md contains "PASSED" -> returns false
    5. No VERIFICATION.md exists -> returns false (assume passed)
    6. UAT.md contains "FAIL" -> returns true
    7. UAT.md contains "Issue Found" -> returns true
    8. Both VERIFICATION.md passed and no UAT issues -> returns false

    Test cases for parsePhaseRange:

    9. parsePhaseRange("3") -> { start: 3, end: 3 }
    10. parsePhaseRange("2-5") -> { start: 2, end: 5 }
    11. parsePhaseRange("1-1") -> { start: 1, end: 1 }
    12. parsePhaseRange("5-3") -> throws "start > end"
    13. parsePhaseRange("abc") -> throws "Invalid phase range"
    14. parsePhaseRange("") -> throws "Invalid phase range"
    15. parsePhaseRange("1-2-3") -> throws "Invalid phase range"

    Test cases for findPhaseDir:

    16. findPhaseDir with phase 3 and directory "03-core-orchestrator" exists -> returns full path
    17. findPhaseDir with phase 99 and no matching directory -> throws error
  </behavior>
  <implementation>
    Create `src/orchestrator/gap-detector.ts`:

    ```typescript
    import { readFile, readdir } from 'node:fs/promises';
    import { join } from 'node:path';

    export async function findPhaseDir(projectDir: string, phaseNumber: number): Promise<string>
    export async function checkForGaps(projectDir: string, phaseNumber: number): Promise<boolean>
    export function parsePhaseRange(range: string): { start: number; end: number }
    ```

    `findPhaseDir(projectDir, phaseNumber)`:
    - Reads `.planning/phases/` directory listing
    - Finds entry starting with zero-padded phase number (e.g., "03-")
    - Returns full path `join(projectDir, '.planning', 'phases', matchedDir)`
    - Throws if no matching directory found

    `checkForGaps(projectDir, phaseNumber)`:
    - Calls findPhaseDir to get the phase directory
    - Reads `{padded}-VERIFICATION.md` -- check for gap indicators: "gaps_found", "GAPS_FOUND"
    - If found, return true. If "passed" or "PASSED", return false.
    - Also check `{padded}-UAT.md` for "FAIL" or "Issue Found"
    - If no files exist (ENOENT), return false (assume passed)
    - Use try/catch for ENOENT handling

    `parsePhaseRange(range)`:
    - Regex match: `/^(\d+)(?:-(\d+))?$/`
    - Extract start and optional end (default end = start)
    - Validate start <= end
    - Throw descriptive error on invalid format or start > end

    CRITICAL: Use path.join for all path construction. Zero-pad phase numbers with padStart(2, '0').
  </implementation>
</feature>

<verification>
1. `cd autopilot && npx vitest run src/orchestrator/__tests__/discuss-handler.test.ts` -- all tests pass
2. `cd autopilot && npx vitest run src/orchestrator/__tests__/gap-detector.test.ts` -- all tests pass
3. `npm run build` -- compiles without errors
4. `npm run typecheck` -- no type errors
5. CONTEXT.md output matches GSD template structure
6. parsePhaseRange handles all edge cases
</verification>

<success_criteria>
- generateSkipDiscussContext produces valid CONTEXT.md with all required sections
- checkForGaps correctly detects gap indicators in VERIFICATION.md and UAT.md
- parsePhaseRange handles N, N-M, and error cases
- findPhaseDir locates phase directories by number prefix
- All TDD tests pass (7+ discuss tests, 10+ gap-detector tests)
- npm run build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-orchestrator/03-02-SUMMARY.md`
</output>
