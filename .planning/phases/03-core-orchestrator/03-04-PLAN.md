---
phase: 03-core-orchestrator
plan: 04
type: execute
wave: 3
depends_on: ["03-03"]
files_modified:
  - autopilot/src/cli/index.ts
  - autopilot/package.json
  - autopilot/src/index.ts
autonomous: true

must_haves:
  truths:
    - "CLI parses --prd, --resume, --skip-discuss, --skip-verify, --phases, --verbose, --quiet flags"
    - "CLI requires --prd when --resume is not set, and does not require --prd when --resume is set"
    - "CLI bootstraps all components (StateStore, ClaudeService, AutopilotLogger, Orchestrator) and wires them together"
    - "CLI installs ShutdownManager before starting orchestrator"
    - "CLI bin entry point is registered in package.json as gsd-autopilot"
    - "Commander.js is installed as a dependency"
  artifacts:
    - path: "autopilot/src/cli/index.ts"
      provides: "CLI entry point with Commander.js"
      min_lines: 60
    - path: "autopilot/package.json"
      provides: "commander dependency and bin entry"
      contains: "commander"
  key_links:
    - from: "autopilot/src/cli/index.ts"
      to: "commander"
      via: "CLI argument parsing"
      pattern: "import.*from.*commander"
    - from: "autopilot/src/cli/index.ts"
      to: "autopilot/src/orchestrator/index.ts"
      via: "creates and runs Orchestrator"
      pattern: "Orchestrator"
    - from: "autopilot/src/cli/index.ts"
      to: "autopilot/src/orchestrator/shutdown.ts"
      via: "creates and installs ShutdownManager"
      pattern: "ShutdownManager"
    - from: "autopilot/src/cli/index.ts"
      to: "autopilot/src/state/index.ts"
      via: "creates or restores StateStore"
      pattern: "StateStore"
    - from: "autopilot/src/cli/index.ts"
      to: "autopilot/src/config/index.ts"
      via: "loads config with CLI overrides"
      pattern: "loadConfig"
    - from: "autopilot/src/cli/index.ts"
      to: "autopilot/src/claude/index.ts"
      via: "creates ClaudeService"
      pattern: "ClaudeService"
    - from: "autopilot/src/cli/index.ts"
      to: "autopilot/src/logger/index.ts"
      via: "creates AutopilotLogger"
      pattern: "AutopilotLogger"
---

<objective>
Build the CLI entry point that bootstraps all components and launches the Orchestrator with Commander.js v14.

Purpose: This is the user-facing entry point -- `npx gsd-autopilot --prd ./idea.md` (CLI-01). It parses CLI arguments, loads configuration, creates all components, wires them together with the ShutdownManager, and starts the orchestrator. This plan also installs Commander.js as a dependency and ensures the bin entry in package.json is correct.

Output: Working CLI entry point that can be invoked via `npx gsd-autopilot`, with all flags documented and Commander.js installed.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-core-orchestrator/03-RESEARCH.md
@.planning/phases/03-core-orchestrator/03-01-SUMMARY.md
@.planning/phases/03-core-orchestrator/03-02-SUMMARY.md
@.planning/phases/03-core-orchestrator/03-03-SUMMARY.md
@autopilot/src/orchestrator/index.ts
@autopilot/src/orchestrator/shutdown.ts
@autopilot/src/state/index.ts
@autopilot/src/config/index.ts
@autopilot/src/claude/index.ts
@autopilot/src/logger/index.ts
@autopilot/src/index.ts
@autopilot/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Commander.js and create CLI entry point</name>
  <files>
    autopilot/src/cli/index.ts
    autopilot/package.json
  </files>
  <action>
1. Install Commander.js v14:
   ```bash
   cd autopilot && npm install commander
   ```
   Verify it appears in package.json dependencies.

2. Verify package.json `bin` entry already points to `./dist/cli/index.js` (it does from Phase 1 skeleton). If not, add it.

3. Create `src/cli/index.ts`:

   ```typescript
   #!/usr/bin/env node
   import { Command } from 'commander';
   import { join, resolve } from 'node:path';
   import { access } from 'node:fs/promises';
   import { loadConfig } from '../config/index.js';
   import { StateStore } from '../state/index.js';
   import { AutopilotLogger } from '../logger/index.js';
   import { ClaudeService } from '../claude/index.js';
   import { Orchestrator } from '../orchestrator/index.js';
   import { ShutdownManager } from '../orchestrator/shutdown.js';
   import { parsePhaseRange } from '../orchestrator/gap-detector.js';
   ```

   Program definition:
   ```typescript
   const program = new Command();

   program
     .name('gsd-autopilot')
     .description('Autonomous GSD workflow orchestrator -- turns a PRD into a built project')
     .version('0.1.0')
     .option('--prd <path>', 'Path to PRD/idea document')
     .option('--resume', 'Resume from last checkpoint')
     .option('--skip-discuss', 'Skip discuss-phase, let Claude decide everything')
     .option('--skip-verify', 'Skip verification step')
     .option('--phases <range>', 'Run specific phases (e.g., 1-3, 2)')
     .option('--notify <channel>', 'Notification channel (console, system, teams, slack)', 'console')
     .option('--webhook-url <url>', 'Webhook URL for Teams/Slack notifications')
     .option('--port <number>', 'Dashboard server port', '3847')
     .option('--depth <level>', 'Planning depth (quick, standard, comprehensive)', 'standard')
     .option('--model <profile>', 'Model profile (quality, balanced, budget)', 'balanced')
     .option('--verbose', 'Verbose output')
     .option('--quiet', 'Suppress non-error output')
     .action(async (options) => {
       // ... bootstrap logic
     });

   await program.parseAsync(process.argv);
   ```

   Action handler implementation:

   a. **Validate --prd / --resume mutual requirement:**
      - If `!options.resume && !options.prd`: print error "Either --prd <path> or --resume is required" and `process.exit(1)`
      - If `options.prd`: resolve to absolute path, verify file exists with `access()`. If not found, print error and exit.

   b. **Determine project directory:**
      - `const projectDir = process.cwd();`

   c. **Load config with CLI overrides:**
      ```typescript
      const config = await loadConfig(projectDir, {
        skipDiscuss: options.skipDiscuss ?? false,
        skipVerify: options.skipVerify ?? false,
        verbose: options.verbose ?? false,
        quiet: options.quiet ?? false,
        depth: options.depth,
        model: options.model,
        notify: options.notify,
        webhookUrl: options.webhookUrl,
        port: parseInt(options.port, 10),
      });
      ```

   d. **Create components:**
      ```typescript
      const logger = new AutopilotLogger(join(projectDir, '.planning', 'autopilot-log'));
      const claudeService = new ClaudeService({ defaultCwd: projectDir });
      const stateStore = options.resume
        ? await StateStore.restore(join(projectDir, '.planning', 'autopilot-state.json'))
        : StateStore.createFresh(projectDir);
      ```

   e. **Parse phase range (if provided):**
      ```typescript
      const phaseRange = options.phases ? parsePhaseRange(options.phases) : undefined;
      ```

   f. **Create Orchestrator:**
      ```typescript
      const orchestrator = new Orchestrator({
        stateStore,
        claudeService,
        logger,
        config,
        projectDir,
      });
      ```

   g. **Install ShutdownManager:**
      ```typescript
      const shutdown = new ShutdownManager();
      shutdown.register(async () => {
        logger.log('info', 'cli', 'Flushing logger on shutdown');
        await logger.flush();
      });
      shutdown.register(async () => {
        logger.log('info', 'cli', 'Persisting state on shutdown');
        await stateStore.setState({ status: 'idle' });
      });
      shutdown.install(() => {
        logger.log('warn', 'cli', 'Shutdown requested, finishing current step...');
        orchestrator.requestShutdown();
      });
      ```

   h. **Run orchestrator:**
      ```typescript
      try {
        const prdPath = options.prd ? resolve(options.prd) : '';
        await orchestrator.run(prdPath, phaseRange);

        if (!options.quiet) {
          console.log('\nâœ“ Autopilot run complete.');
        }
      } catch (err) {
        const message = err instanceof Error ? err.message : String(err);
        logger.log('error', 'cli', 'Autopilot failed', { error: message });
        if (!options.quiet) {
          console.error(`\nAutopilot failed: ${message}`);
        }
        process.exit(1);
      }
      ```

   i. **Top-level error handling:**
      Wrap the entire `program.parseAsync()` call in a try/catch to handle unexpected errors gracefully:
      ```typescript
      try {
        await program.parseAsync(process.argv);
      } catch (err) {
        console.error('Fatal error:', err instanceof Error ? err.message : err);
        process.exit(1);
      }
      ```

CRITICAL: The shebang `#!/usr/bin/env node` MUST be the first line of the file for npx/bin execution.
CRITICAL: Import paths use .js extensions for ESM compatibility.
CRITICAL: Use `parseAsync()` not `parse()` -- the action handler is async.
CRITICAL: The --prd option is NOT marked as `.requiredOption()` because it is optional when --resume is used. Validation is done manually in the action handler.
  </action>
  <verify>
Run `cd autopilot && npm run typecheck` -- must pass with zero errors.
Run `cd autopilot && npm run build` -- must compile successfully.
Verify `dist/cli/index.js` exists after build.
Verify Commander.js is listed in package.json dependencies.
Run `cd autopilot && node dist/cli/index.js --help` -- must show all flag descriptions.
  </verify>
  <done>
CLI entry point compiles and shows help output with all flags. Commander.js is installed. The bin entry in package.json points to dist/cli/index.js. --prd is required only when --resume is not set.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update package entry point and verify full build</name>
  <files>
    autopilot/src/index.ts
  </files>
  <action>
1. Verify `src/index.ts` has all orchestrator module exports added (from Plan 03 Task 1). If any are missing, add them:
   ```typescript
   export { Orchestrator } from './orchestrator/index.js';
   export { ShutdownManager } from './orchestrator/shutdown.js';
   export { writeYoloConfig } from './orchestrator/yolo-config.js';
   export { generateSkipDiscussContext, writeSkipDiscussContext } from './orchestrator/discuss-handler.js';
   export { checkForGaps, parsePhaseRange } from './orchestrator/gap-detector.js';
   ```

   Also export the types needed by consumers:
   ```typescript
   export type { OrchestratorOptions } from './orchestrator/index.js';
   export type { PhaseInfo } from './orchestrator/discuss-handler.js';
   ```

2. Run the full build and test suite:
   ```bash
   cd autopilot && npm run build && npm test
   ```

3. Verify the CLI is executable:
   ```bash
   cd autopilot && node dist/cli/index.js --help
   cd autopilot && node dist/cli/index.js --version
   ```

4. Verify --prd validation works:
   ```bash
   cd autopilot && node dist/cli/index.js 2>&1 || true
   # Should show "Either --prd <path> or --resume is required"
   ```

5. Verify --resume does not require --prd:
   ```bash
   cd autopilot && node dist/cli/index.js --resume 2>&1 || true
   # Should attempt to restore state (may fail with "State file not found" -- that's correct)
   ```
  </action>
  <verify>
Run `cd autopilot && npm run build` -- must compile successfully with zero errors.
Run `cd autopilot && npm test` -- all tests must pass (no regressions from any prior phase).
Run `cd autopilot && node dist/cli/index.js --help` -- must show all flags.
  </verify>
  <done>
Full build succeeds. All tests pass (existing Phase 1 + Phase 2 + new Phase 3 tests). CLI --help shows all flags. Package entry point exports all orchestrator modules. The autopilot is structurally complete for Phase 3 -- ready for Phase 4 (Response Server) and Phase 6 (Notifications) to add the web UI and notification channels.
  </done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes in autopilot/ directory
- `npm run build` succeeds in autopilot/ directory
- `npm test` runs all tests with zero failures
- `node dist/cli/index.js --help` shows all flags with descriptions
- `node dist/cli/index.js --version` shows 0.1.0
- Commander.js is in package.json dependencies
- Orchestrator, ShutdownManager, and all utilities importable from `@gsd/autopilot`
- CLI validates --prd requirement correctly (required without --resume, optional with --resume)
</verification>

<success_criteria>
- CLI parses all flags: --prd, --resume, --skip-discuss, --skip-verify, --phases, --notify, --webhook-url, --port, --depth, --model, --verbose, --quiet
- CLI bootstraps StateStore (fresh or restore), ClaudeService, AutopilotLogger, Orchestrator
- ShutdownManager installed with logger flush and state persist handlers
- --prd required only without --resume
- Commander.js v14 installed as dependency
- Full build and test suite pass
- CLI is executable via node dist/cli/index.js
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-orchestrator/03-04-SUMMARY.md`
</output>
