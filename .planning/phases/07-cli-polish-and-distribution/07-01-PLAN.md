---
phase: 07-cli-polish-and-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autopilot/src/cli/preflight.ts
  - autopilot/src/orchestrator/gap-detector.ts
  - autopilot/src/cli/index.ts
autonomous: true

must_haves:
  truths:
    - "Preflight checks validate claude CLI, PRD file, port availability, and GSD installation -- reporting ALL failures at once before exiting"
    - "Error messages include actionable fix steps (e.g., 'Claude CLI not found. Install it: npm install -g @anthropic-ai/claude-code')"
    - "--phases accepts comma-separated ranges (e.g., '1-3,5,7-9') and returns a sorted deduplicated number array"
    - "When --resume is used with no previous state file, CLI offers actionable guidance to start fresh with --prd"
    - "Commander shows help after errors and displays usage examples in --help output"
  artifacts:
    - path: "autopilot/src/cli/preflight.ts"
      provides: "Preflight check runner with parallel validation"
      exports: ["runPreflightChecks"]
    - path: "autopilot/src/orchestrator/gap-detector.ts"
      provides: "Enhanced parsePhaseRange supporting comma-separated ranges"
      exports: ["parsePhaseRange"]
    - path: "autopilot/src/cli/index.ts"
      provides: "CLI with preflight checks, actionable errors, and resume-no-state handling"
      contains: "runPreflightChecks"
  key_links:
    - from: "autopilot/src/cli/index.ts"
      to: "autopilot/src/cli/preflight.ts"
      via: "import { runPreflightChecks }"
      pattern: "import.*runPreflightChecks"
    - from: "autopilot/src/cli/index.ts"
      to: "autopilot/src/orchestrator/gap-detector.ts"
      via: "import { parsePhaseRange }"
      pattern: "parsePhaseRange"
---

<objective>
Add preflight validation, actionable error messaging, enhanced phase range parsing, and resume-with-no-state handling to the CLI.

Purpose: Users get clear, actionable feedback when prerequisites are missing or configuration is wrong, rather than cryptic runtime failures. The --phases flag becomes more flexible with comma-separated ranges.
Output: New preflight module, enhanced phase range parser, improved CLI error handling.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cli-polish-and-distribution/07-RESEARCH.md
@autopilot/src/cli/index.ts
@autopilot/src/orchestrator/gap-detector.ts
@autopilot/src/types/config.ts
@autopilot/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preflight checks module and enhance phase range parser</name>
  <files>
    autopilot/src/cli/preflight.ts
    autopilot/src/orchestrator/gap-detector.ts
  </files>
  <action>
**1. Create `autopilot/src/cli/preflight.ts`:**

Create a preflight check module that validates all prerequisites in parallel and reports ALL failures at once (per user decision -- not one-at-a-time).

```typescript
import { access } from 'node:fs/promises';
import { createServer } from 'node:net';
import { execFile } from 'node:child_process';
import { promisify } from 'node:util';
import type { AutopilotConfig } from '../types/index.js';

const execFileAsync = promisify(execFile);

interface PreflightCheck {
  name: string;
  check: () => Promise<boolean>;
  error: string;
  fix: string;
}

export interface PreflightFailure {
  error: string;
  fix: string;
}
```

Implement `runPreflightChecks(config: AutopilotConfig, prdPath?: string): Promise<PreflightFailure[]>` that runs these checks in parallel via `Promise.all`:

1. **Claude CLI installed**: Try `execFileAsync('claude', ['--version'])`. Catch means not installed. Error: "Claude CLI not found". Fix: "Install it: npm install -g @anthropic-ai/claude-code"
2. **PRD file exists** (skip if no prdPath): Try `access(resolve(prdPath))`. Catch means not found. Error: `PRD file not found: ${prdPath}`. Fix: "Check the path and try again, or use --resume to continue a previous run"
3. **Port available**: Use `createServer()` pattern from research -- listen on config.port, resolve true on 'listening', false on 'error'. Remember to close the server after test. Error: `Port ${config.port} is already in use`. Fix: "Use --port <number> to specify a different port"
4. **GSD installation**: Check if `~/.claude/get-shit-done/` exists using `access()`. Use `homedir()` from `node:os`. Error: "GSD workflows not found". Fix: "Install GSD: npm install -g get-shit-done-cc"

Return array of failures (empty array = all passed). Do NOT call process.exit -- let the caller handle that.

**2. Enhance `parsePhaseRange` in `autopilot/src/orchestrator/gap-detector.ts`:**

The existing `parsePhaseRange` returns `{ start: number; end: number }` and only handles "N" or "N-M". Update it to support comma-separated ranges and return a sorted, deduplicated `number[]` instead.

New signature: `parsePhaseRange(input: string): number[]`

Implementation (per research pattern):
- Split on commas, trim each segment
- For each segment:
  - If matches `/^\d+$/`: add that single number
  - If matches `/^(\d+)-(\d+)$/`: add all numbers in range (validate start <= end)
  - Otherwise: throw with format guidance: `Invalid phase specifier: "${segment}". Expected format: "N", "N-M", or comma-separated (e.g., "1-3,5,7-9")`
- Return `Array.from(new Set(phases)).sort((a, b) => a - b)`

This is a BREAKING CHANGE to the return type. Update the caller in `cli/index.ts` (Task 2) to handle the new `number[]` return type.

Also update the existing tests in `autopilot/src/orchestrator/__tests__/gap-detector.test.ts`:
- Existing "3" test: now returns `[3]` instead of `{ start: 3, end: 3 }`
- Existing "2-5" test: now returns `[2, 3, 4, 5]` instead of `{ start: 2, end: 5 }`
- Add test: "1-3,5,7-9" returns `[1, 2, 3, 5, 7, 8, 9]`
- Add test: "3,3,5,5" returns `[3, 5]` (deduplication)
- Add test: "5-3" throws (start > end)
- Existing invalid format tests should still throw
  </action>
  <verify>
Run `cd C:/GitHub/GetShitDone/get-shit-done/autopilot && npx tsc --noEmit` -- compiles clean (may have temporary error in cli/index.ts due to return type change, fixed in Task 2).
Run `npx vitest run src/orchestrator/__tests__/gap-detector.test.ts` -- all tests pass including new comma-separated range tests.
Grep for `runPreflightChecks` in `src/cli/preflight.ts` -- exported function exists.
  </verify>
  <done>
Preflight module exports runPreflightChecks that validates 4 prerequisites in parallel, returns failure array with actionable error+fix pairs. parsePhaseRange accepts "1-3,5,7-9" format and returns sorted deduplicated number array. Tests updated and passing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire preflight checks into CLI, add actionable errors, handle resume-no-state</name>
  <files>
    autopilot/src/cli/index.ts
  </files>
  <action>
**1. Add imports:**
```typescript
import { runPreflightChecks } from './preflight.js';
```

**2. Update Commander configuration** (at the top of the program chain):

Add `.showHelpAfterError('(run gsd-autopilot --help for usage information)')` to the Commander chain.

Add `.addHelpText('after', ...)` with usage examples:
```
Example:
  $ gsd-autopilot --prd ./idea.md
  $ gsd-autopilot --resume
  $ gsd-autopilot --prd ./spec.md --notify teams --webhook-url https://...
  $ gsd-autopilot --prd ./plan.md --phases 1-3,5 --depth comprehensive

Dashboard:
  http://localhost:3847 (configurable with --port)
```

Add `.configureOutput()` for friendlier error formatting:
- `outputError: (str, write)` should prefix with a cross mark and add tip about --help when relevant

**3. Replace the simple --prd/--resume validation** with actionable error messaging:

Currently:
```typescript
if (!options.resume && !options.prd) {
  console.error('Error: Either --prd <path> or --resume is required');
  process.exit(1);
}
```

Replace with:
```typescript
if (!options.resume && !options.prd) {
  console.error('Error: No input specified\n');
  console.error('You must provide either:');
  console.error('  --prd <path>   Start a new run with a PRD document');
  console.error('  --resume       Continue from last checkpoint\n');
  console.error('Run gsd-autopilot --help for more information');
  process.exit(1);
}
```

**4. Handle --resume with no state file:**

Currently the code does:
```typescript
const stateStore = options.resume
  ? await StateStore.restore(...)
  : StateStore.createFresh(projectDir);
```

Wrap the restore in try/catch. If restore fails (file not found), print actionable message:
```typescript
if (options.resume) {
  try {
    stateStore = await StateStore.restore(join(projectDir, '.planning', 'autopilot-state.json'));
  } catch {
    console.error('No previous run found in this directory.\n');
    console.error('To start a new run:');
    console.error('  gsd-autopilot --prd <path-to-your-prd>\n');
    console.error('The --resume flag requires a previous autopilot run in the current directory.');
    process.exit(1);
  }
} else {
  stateStore = StateStore.createFresh(projectDir);
}
```

**5. Run preflight checks after config loading, before component creation:**

Insert after `const config = await loadConfig(...)` and before component creation:

```typescript
// Run preflight checks -- validate ALL prerequisites at once
const preflightFailures = await runPreflightChecks(config, options.prd);
if (preflightFailures.length > 0) {
  console.error('\nPreflight checks failed:\n');
  for (const failure of preflightFailures) {
    console.error(`  x ${failure.error}`);
    console.error(`    ${failure.fix}\n`);
  }
  process.exit(1);
}
```

**6. Update phaseRange usage** to handle the new `number[]` return type from `parsePhaseRange`:

Currently: `const phaseRange = options.phases ? parsePhaseRange(options.phases) : undefined;`

The Orchestrator's `run()` method currently expects `{ start: number; end: number } | undefined`. Update the variable to pass the array directly. Check the Orchestrator.run() signature -- if it takes `{ start, end }`, convert: create `{ start: Math.min(...arr), end: Math.max(...arr) }`. But the array is more flexible for non-contiguous ranges. Since the Orchestrator likely filters phases by checking `phase >= range.start && phase <= range.end`, the simplest approach is to pass the array and let the Orchestrator filter with `phaseRange.includes(phaseNumber)`.

Check the actual Orchestrator.run() signature first. If it takes `{ start, end }`, update it to accept `number[]` instead, or convert at the call site.

**7. Wrap loadConfig errors** with actionable messaging:

```typescript
let config: AutopilotConfig;
try {
  config = await loadConfig(projectDir, { ... });
} catch (err) {
  const msg = err instanceof Error ? err.message : String(err);
  console.error(`Configuration error: ${msg}\n`);
  console.error('Check your .gsd-autopilot.json file or CLI flags.');
  console.error('Run gsd-autopilot --help for valid options.');
  process.exit(1);
}
```
  </action>
  <verify>
Run `cd C:/GitHub/GetShitDone/get-shit-done/autopilot && npx tsc --noEmit` -- compiles clean.
Run `npx vitest run` -- all tests pass.
Run `node dist/cli/index.js --help` -- shows all flags including examples and dashboard URL.
Run `node dist/cli/index.js` (no args) -- shows actionable "No input specified" error with --prd and --resume guidance.
  </verify>
  <done>
CLI runs preflight checks on startup reporting all failures at once with fix instructions. --resume with no state file shows actionable guidance to use --prd. Error messages include specific fix steps. Commander shows help after errors and displays usage examples in --help. parsePhaseRange return type change integrated into CLI.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` in autopilot/ -- full build succeeds
- `npx vitest run` -- all tests pass including enhanced parsePhaseRange tests
- `node dist/cli/index.js --help` shows all documented flags plus examples
- `node dist/cli/index.js` (no args) shows actionable error with --prd/--resume guidance
- Preflight checks validate claude CLI, PRD file, port, GSD installation in parallel
- Error messages always include actionable fix steps
</verification>

<success_criteria>
- Preflight checks run before orchestrator, catch all prerequisite issues at once
- Error messages are actionable: every error tells the user what to DO
- --phases accepts "1-3,5,7-9" format and returns correct sorted deduplicated array
- --resume with no previous state gives clear "start fresh with --prd" guidance
- --help shows complete flag list and usage examples
- All existing tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/07-cli-polish-and-distribution/07-01-SUMMARY.md`
</output>
