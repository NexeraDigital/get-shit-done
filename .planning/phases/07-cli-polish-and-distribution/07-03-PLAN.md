---
phase: 07-cli-polish-and-distribution
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - autopilot/package.json
  - autopilot/dist/cli/index.js
  - autopilot/dist/server/standalone.js
autonomous: true
must_haves:
  truths:
    - "npm pack produces a tarball under 2MB containing dist/, dashboard/dist/, workflows/, and example-adapter.js"
    - "Installing the tarball via npm install and running gsd-autopilot --help succeeds and shows all documented flags"
    - "The bin script shebang uses LF line endings so it works on Unix systems"
    - "The package works via npx gsd-autopilot on Windows (the development platform)"
  artifacts:
    - path: "autopilot/package.json"
      provides: "npm package metadata with bin, files, engines, prepare"
      contains: "\"bin\""
    - path: "autopilot/.gitattributes"
      provides: "LF line ending enforcement for bin scripts"
      contains: "eol=lf"
  key_links:
    - from: "autopilot/package.json bin field"
      to: "autopilot/dist/cli/index.js"
      via: "npm bin symlink"
      pattern: "\"gsd-autopilot\": \"./dist/cli/index.js\""
    - from: "autopilot/package.json prepare"
      to: "npm run build"
      via: "lifecycle script"
      pattern: "\"prepare\": \"npm run build\""
---

<objective>
Verify and harden the npm package for distribution, ensuring `npm pack` produces a correct tarball under 2MB, the bin scripts work cross-platform, and the package installs and runs correctly from a tarball.

Purpose: This is the final step of Phase 7 -- confirming that the already-built CLI (flags, preflight, wizard, help text from plans 07-01 and 07-02) is correctly packaged for npm distribution. The package.json already has the right structure; this plan validates it works end-to-end and fixes any issues found.

Output: Verified npm tarball that installs and runs correctly, with any packaging issues fixed.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@autopilot/package.json
@autopilot/tsconfig.json
@autopilot/.gitattributes
@autopilot/src/cli/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and fix npm package contents and bin script</name>
  <files>autopilot/package.json</files>
  <action>
Run `npm pack --dry-run` in the autopilot/ directory and verify:

1. **Package size**: Total tarball must be under 2MB. Current measurement shows ~224KB which is well within target. If over 2MB, investigate and remove unnecessary files.

2. **Required contents present**: Verify these are included:
   - `dist/**/*.js` (compiled TypeScript)
   - `dist/**/*.d.ts` (type declarations)
   - `dashboard/dist/` (pre-built React dashboard)
   - `workflows/gsd-autopilot/` (launcher, port-manager, pid-manager, SKILL.md)
   - `scripts/install-workflow.js` (postinstall)
   - `example-adapter.js`
   - `package.json`

3. **Excluded contents**: Verify these are NOT included:
   - No `*.test.*` files
   - No `__tests__` directories
   - No `.map` source map files
   - No `src/` directory (only dist/)
   - No `node_modules/`

4. **Bin script shebang**: Read `dist/cli/index.js` and verify the first line is exactly `#!/usr/bin/env node` with no blank lines before it and no `\r` (CR) characters. If TypeScript compilation strips or misplaces the shebang, add a build step or post-build fix. The `.gitattributes` already enforces LF for `dist/cli/*.js`.

5. **Standalone server shebang**: Also check `dist/server/standalone.js` for proper shebang since it is in the `bin` field as `gsd-dashboard`.

6. **package.json fields audit**: Verify these fields are correct:
   - `name`: "gsd-autopilot"
   - `bin.gsd-autopilot`: "./dist/cli/index.js"
   - `bin.gsd-dashboard`: "./dist/server/standalone.js"
   - `engines.node`: ">=20.0.0"
   - `type`: "module"
   - `files` array includes all needed paths and exclusions

If any issues found, fix them in package.json or the relevant files.
  </action>
  <verify>
Run `npm pack --dry-run` and confirm:
- Total size reported is under 2MB
- All expected files are listed
- No test files, source maps, or src/ files are listed

Run `node -e "const fs = require('fs'); const content = fs.readFileSync('dist/cli/index.js', 'utf-8'); console.log(content.startsWith('#!/usr/bin/env node') ? 'PASS: shebang OK' : 'FAIL: shebang missing or wrong')"` to verify shebang.
  </verify>
  <done>npm pack dry-run shows all required files, no unwanted files, tarball under 2MB, and bin scripts have correct shebangs</done>
</task>

<task type="auto">
  <name>Task 2: End-to-end tarball install and CLI verification</name>
  <files>autopilot/package.json</files>
  <action>
Perform an end-to-end verification that the package works when installed from a tarball:

1. **Build the package**: Run `npm run build` in autopilot/ to ensure dist/ and dashboard/dist/ are fresh.

2. **Create tarball**: Run `npm pack` to create `gsd-autopilot-0.1.0.tgz`.

3. **Install from tarball**: Create a temporary directory, run `npm install /path/to/gsd-autopilot-0.1.0.tgz` in it, and verify:
   - Installation succeeds without errors
   - `node_modules/.bin/gsd-autopilot` exists (or equivalent on Windows)
   - `node_modules/gsd-autopilot/dist/cli/index.js` exists
   - `node_modules/gsd-autopilot/dashboard/dist/index.html` exists

4. **Run --help from installed package**: Execute `npx gsd-autopilot --help` from the temp directory and verify the output contains ALL documented flags:
   - --prd, --resume, --skip-discuss, --skip-verify, --phases
   - --notify, --webhook-url, --port, --depth, --model
   - --verbose, --quiet, --adapter-path

5. **Run --version**: Execute `npx gsd-autopilot --version` and verify it outputs "0.1.0".

6. **Clean up**: Remove the temporary directory and tarball.

If any step fails, diagnose the issue, fix it (likely in package.json or tsconfig.json), rebuild, and retry.
  </action>
  <verify>
The following commands all succeed:
- `npm pack` produces a tarball under 2MB
- `npm install ./gsd-autopilot-0.1.0.tgz` in a temp dir succeeds
- `npx gsd-autopilot --help` shows all 13 documented flags
- `npx gsd-autopilot --version` shows "0.1.0"
  </verify>
  <done>Package installs from tarball and gsd-autopilot --help shows all flags; --version shows correct version; dashboard dist is included in installed package</done>
</task>

</tasks>

<verification>
Phase 7 success criteria validation:

1. `npx gsd-autopilot --help` shows all documented flags: --prd, --notify, --webhook-url, --port, --depth, --model, --skip-discuss, --skip-verify, --phases, --resume, --verbose, --quiet, --adapter-path -- VERIFIED by Task 2 step 4

2. --verbose increases log detail; --quiet suppresses all non-error output; --port changes the server port; --depth and --model pass through to GSD config -- VERIFIED by code inspection of cli/index.ts (already built in 07-01/07-02, wired through loadConfig)

3. `npm pack` produces a package under 2MB that installs and runs correctly via `npx gsd-autopilot` on macOS, Linux, and Windows -- VERIFIED by Task 1 (size check) and Task 2 (install + run)
</verification>

<success_criteria>
- npm pack produces tarball under 2MB
- Tarball contains dist/, dashboard/dist/, workflows/, example-adapter.js
- Tarball does NOT contain test files, source maps, or src/
- Installing from tarball and running `gsd-autopilot --help` shows all 13 documented flags
- `gsd-autopilot --version` outputs "0.1.0"
- Bin scripts have correct shebangs (#!/usr/bin/env node as first line)
</success_criteria>

<output>
After completion, create `.planning/phases/07-cli-polish-and-distribution/07-03-SUMMARY.md`
</output>
