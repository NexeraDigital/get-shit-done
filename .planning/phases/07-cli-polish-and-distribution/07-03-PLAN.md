---
phase: 07-cli-polish-and-distribution
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - autopilot/package.json
  - autopilot/dist/cli/index.js
  - autopilot/dist/server/standalone.js
  - autopilot/.gitattributes
autonomous: true
must_haves:
  truths:
    - "npm pack produces a tarball under 2MB containing dist/, dashboard/dist/, workflows/, and example-adapter.js"
    - "Installing the tarball via npm install and running gsd-autopilot --help succeeds and shows all documented flags"
    - "Package bin scripts are structured for Unix compatibility (correct shebangs, LF line endings enforced via .gitattributes)"
    - "The package works via npx gsd-autopilot on Windows (the development platform)"
  artifacts:
    - path: "autopilot/package.json"
      provides: "npm package metadata with bin, files, engines, prepare"
      contains: "\"bin\""
    - path: "autopilot/.gitattributes"
      provides: "LF line ending enforcement for bin scripts"
      contains: "eol=lf"
  key_links:
    - from: "autopilot/package.json bin field"
      to: "autopilot/dist/cli/index.js"
      via: "npm bin symlink"
      pattern: "\"gsd-autopilot\": \"./dist/cli/index.js\""
    - from: "autopilot/package.json files array"
      to: "tarball contents (dist/, dashboard/dist/, workflows/)"
      via: "npm pack file inclusion"
      pattern: "\"files\".*\"dist\""
---

<objective>
Verify and harden the npm package for distribution, ensuring `npm pack` produces a correct tarball under 2MB, the bin scripts work cross-platform, and the package installs and runs correctly from a tarball.

Purpose: This is the final step of Phase 7 -- confirming that the already-built CLI (flags, preflight, wizard, help text from plans 07-01 and 07-02) is correctly packaged for npm distribution. The package.json already has the right structure; this plan validates it works end-to-end and fixes any issues found.

Output: Verified npm tarball that installs and runs correctly, with any packaging issues fixed.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@autopilot/package.json
@autopilot/tsconfig.json
@autopilot/.gitattributes
@autopilot/src/cli/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and fix npm package contents and metadata</name>
  <files>autopilot/package.json</files>
  <action>
Run `npm pack --dry-run` in the autopilot/ directory and verify package contents and metadata:

1. **Package size**: Total tarball must be under 2MB. Current measurement shows ~224KB which is well within target. If over 2MB, investigate and remove unnecessary files.

2. **Required contents present**: Verify these are included in the dry-run output:
   - `dist/**/*.js` (compiled TypeScript)
   - `dist/**/*.d.ts` (type declarations)
   - `dashboard/dist/` (pre-built React dashboard)
   - `workflows/gsd-autopilot/` (launcher, port-manager, pid-manager, SKILL.md)
   - `scripts/install-workflow.js` (postinstall)
   - `example-adapter.js`
   - `package.json`

3. **Excluded contents**: Verify these are NOT included:
   - No `*.test.*` files
   - No `__tests__` directories
   - No `.map` source map files
   - No `src/` directory (only dist/)
   - No `node_modules/`

4. **package.json fields audit**: Verify these fields are correct:
   - `name`: "gsd-autopilot"
   - `bin.gsd-autopilot`: "./dist/cli/index.js"
   - `bin.gsd-dashboard`: "./dist/server/standalone.js"
   - `engines.node`: ">=20.0.0"
   - `type`: "module"
   - `files` array includes all needed paths and exclusions

If any issues found, fix them in package.json.
  </action>
  <verify>
Run `npm pack --dry-run` and confirm:
- Total size reported is under 2MB
- All expected files are listed (dist/, dashboard/dist/, workflows/, scripts/, example-adapter.js)
- No test files, source maps, or src/ files are listed
- package.json has correct name, bin, engines, type, and files fields
  </verify>
  <done>npm pack dry-run shows all required files, no unwanted files, tarball under 2MB, and package.json fields are correct</done>
</task>

<task type="auto">
  <name>Task 2: Verify bin script shebangs and Unix compatibility</name>
  <files>autopilot/dist/cli/index.js, autopilot/dist/server/standalone.js, autopilot/.gitattributes</files>
  <action>
Verify that bin scripts are structured for Unix compatibility:

1. **CLI shebang**: Read `dist/cli/index.js` and verify the first line is exactly `#!/usr/bin/env node` with no blank lines before it and no `\r` (CR) characters. If TypeScript compilation strips or misplaces the shebang, add a build step or post-build fix.

2. **Standalone server shebang**: Read `dist/server/standalone.js` and verify it also has `#!/usr/bin/env node` as its first line with no `\r` characters, since it is in the `bin` field as `gsd-dashboard`.

3. **Gitattributes LF enforcement**: Verify `autopilot/.gitattributes` contains rules enforcing LF line endings for bin scripts (e.g., `dist/cli/*.js eol=lf`). This ensures that even on Windows (which uses CRLF), git will store these files with LF endings.

If any shebang is missing or malformed, fix the TypeScript source or add a post-build script to prepend/fix it. If .gitattributes is missing LF rules, add them.
  </action>
  <verify>
Run these checks from the autopilot/ directory:
- `node -e "const fs = require('fs'); const c = fs.readFileSync('dist/cli/index.js', 'utf-8'); console.log(c.startsWith('#!/usr/bin/env node') && !c.startsWith('#!/usr/bin/env node\r') ? 'PASS' : 'FAIL')"` outputs PASS
- `node -e "const fs = require('fs'); const c = fs.readFileSync('dist/server/standalone.js', 'utf-8'); console.log(c.startsWith('#!/usr/bin/env node') && !c.startsWith('#!/usr/bin/env node\r') ? 'PASS' : 'FAIL')"` outputs PASS
- `cat .gitattributes` shows eol=lf rules for bin scripts
  </verify>
  <done>Both bin scripts (dist/cli/index.js and dist/server/standalone.js) have correct shebangs with LF line endings, and .gitattributes enforces LF for bin scripts</done>
</task>

<task type="auto">
  <name>Task 3: End-to-end tarball install and CLI command verification</name>
  <files>autopilot/package.json, autopilot/gsd-autopilot-*.tgz (created then removed), /tmp/gsd-tarball-test/ (temp dir, created then removed)</files>
  <action>
Perform an end-to-end verification that the package works when installed from a tarball:

1. **Build the package**: Run `npm run build` in autopilot/ to ensure dist/ and dashboard/dist/ are fresh.

2. **Create tarball**: Run `npm pack` to create `gsd-autopilot-0.1.0.tgz`.

3. **Install from tarball**: Create a temporary directory, run `npm init -y && npm install /path/to/gsd-autopilot-0.1.0.tgz` in it, and verify:
   - Installation succeeds without errors
   - `node_modules/.bin/gsd-autopilot` exists (or equivalent on Windows)
   - `node_modules/gsd-autopilot/dist/cli/index.js` exists
   - `node_modules/gsd-autopilot/dashboard/dist/index.html` exists
   - `node_modules/gsd-autopilot/workflows/` directory exists
   - `node_modules/gsd-autopilot/example-adapter.js` exists
   NOTE: `npm install <tarball>` does NOT run the `prepare` lifecycle script. The tarball already contains pre-built dist/ files from `npm pack`. This is correct -- we verify dist/ presence rather than prepare execution.

4. **Run --help**: Execute `npx gsd-autopilot --help` from the temp directory and verify the output contains ALL documented flags:
   - --prd, --resume, --skip-discuss, --skip-verify, --phases
   - --notify, --webhook-url, --port, --depth, --model
   - --verbose, --quiet, --adapter-path

5. **Run --version**: Execute `npx gsd-autopilot --version` and verify it outputs "0.1.0".

6. **Clean up**: Remove the temporary directory and tarball.

If any step fails, diagnose the issue, fix it (likely in package.json or tsconfig.json), rebuild, and retry.
  </action>
  <verify>
The following commands all succeed in sequence:
- `npm pack` in autopilot/ produces a tarball
- `npm init -y && npm install ./gsd-autopilot-0.1.0.tgz` in a temp dir succeeds
- `ls node_modules/gsd-autopilot/dist/cli/index.js` confirms dist/ included in tarball
- `npx gsd-autopilot --help` shows all 13 documented flags
- `npx gsd-autopilot --version` shows "0.1.0"
  </verify>
  <done>Package installs from tarball, dist/ is present (not built via prepare), gsd-autopilot --help shows all 13 flags, --version shows correct version, and all package contents are accessible</done>
</task>

</tasks>

<verification>
Phase 7 success criteria validation:

1. `npx gsd-autopilot --help` shows all documented flags: --prd, --notify, --webhook-url, --port, --depth, --model, --skip-discuss, --skip-verify, --phases, --resume, --verbose, --quiet, --adapter-path -- VERIFIED by Task 3 step 4

2. --verbose increases log detail; --quiet suppresses all non-error output; --port changes the server port; --depth and --model pass through to GSD config -- VERIFIED by code inspection of cli/index.ts (already built in 07-01/07-02, wired through loadConfig)

3. `npm pack` produces a package under 2MB that installs and runs correctly via `npx gsd-autopilot` -- VERIFIED on Windows (development platform) by Task 1 (package contents) and Task 3 (install + run). Unix compatibility ensured structurally: correct shebangs verified in Task 2, LF line endings enforced by .gitattributes verified in Task 2. Runtime testing on macOS/Linux deferred to CI/CD or manual testing on those platforms.
</verification>

<success_criteria>
- npm pack produces tarball under 2MB
- Tarball contains dist/, dashboard/dist/, workflows/, example-adapter.js
- Tarball does NOT contain test files, source maps, or src/
- Installing from tarball and running `gsd-autopilot --help` shows all 13 documented flags
- `gsd-autopilot --version` outputs "0.1.0"
- Bin scripts have correct shebangs (#!/usr/bin/env node as first line)
</success_criteria>

<output>
After completion, create `.planning/phases/07-cli-polish-and-distribution/07-03-SUMMARY.md`
</output>
