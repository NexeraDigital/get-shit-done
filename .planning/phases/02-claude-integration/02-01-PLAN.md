---
phase: 02-claude-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autopilot/src/claude/types.ts
  - autopilot/src/claude/polyfills.ts
  - autopilot/src/claude/timeout.ts
  - autopilot/src/claude/__tests__/timeout.test.ts
  - autopilot/src/index.ts
  - autopilot/package.json
  - autopilot/tsconfig.json
autonomous: true

must_haves:
  truths:
    - "CommandResult, RunCommandOptions, and QuestionEvent types are importable from the package entry point"
    - "Promise.withResolvers polyfill works on Node 20 and is a no-op on Node 22+"
    - "Timeout wrapper creates an AbortController that aborts after the configured duration and cleans up on success"
    - "@anthropic-ai/claude-agent-sdk is installed as a dependency"
  artifacts:
    - path: "autopilot/src/claude/types.ts"
      provides: "CommandResult, RunCommandOptions, QuestionEvent types"
      exports: ["CommandResult", "RunCommandOptions", "QuestionEvent"]
    - path: "autopilot/src/claude/polyfills.ts"
      provides: "Promise.withResolvers polyfill and global type declaration"
      contains: "Promise.withResolvers"
    - path: "autopilot/src/claude/timeout.ts"
      provides: "createTimeout utility returning AbortController + cleanup"
      exports: ["createTimeout"]
    - path: "autopilot/src/claude/__tests__/timeout.test.ts"
      provides: "Tests for timeout utility"
      min_lines: 30
  key_links:
    - from: "autopilot/src/claude/timeout.ts"
      to: "AbortController"
      via: "setTimeout + clearTimeout"
      pattern: "AbortController"
    - from: "autopilot/src/claude/polyfills.ts"
      to: "Promise.withResolvers"
      via: "global polyfill assignment"
      pattern: "Promise\\.withResolvers"
---

<objective>
Create the foundational types, polyfills, and timeout utility for the Claude integration layer.

Purpose: Establish the type contracts (CommandResult, RunCommandOptions, QuestionEvent) that all other Claude integration modules depend on. Install the Agent SDK. Provide the Promise.withResolvers polyfill needed for Node 20 compatibility. Build the timeout wrapper that every command execution will use.

Output: Type definitions, polyfill, timeout utility with tests, Agent SDK installed as dependency.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-claude-integration/02-RESEARCH.md
@autopilot/src/types/state.ts
@autopilot/src/types/config.ts
@autopilot/src/index.ts
@autopilot/package.json
@autopilot/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Claude integration types, polyfill, and install SDK</name>
  <files>
    autopilot/src/claude/types.ts
    autopilot/src/claude/polyfills.ts
    autopilot/src/index.ts
    autopilot/package.json
    autopilot/tsconfig.json
  </files>
  <action>
1. Install the Claude Agent SDK:
   ```bash
   cd autopilot && npm install @anthropic-ai/claude-agent-sdk
   ```

2. Update `tsconfig.json`: Change `"lib": ["ES2023"]` to `"lib": ["ES2024"]` so TypeScript recognizes `Promise.withResolvers` type.

3. Create `src/claude/types.ts` with these types (following existing pattern of `export type` for verbatimModuleSyntax):

   ```typescript
   export interface CommandResult {
     success: boolean;
     result?: string;
     error?: string;
     sessionId: string;
     durationMs: number;
     costUsd: number;
     numTurns: number;
   }

   export interface RunCommandOptions {
     timeoutMs?: number;    // Default: 600_000 (10 minutes)
     cwd?: string;          // Working directory for the command
     phase?: number;        // Current phase number (for logging)
     step?: string;         // Current step name (for logging)
   }

   export interface QuestionOption {
     label: string;
     description: string;
   }

   export interface QuestionItem {
     question: string;
     header: string;
     options: QuestionOption[];
     multiSelect: boolean;
   }

   export interface QuestionEvent {
     id: string;
     phase?: number;
     step?: string;
     questions: QuestionItem[];
     createdAt: string;
   }
   ```

   These types are derived from the SDK's `AskUserQuestionInput` and `SDKResultMessage` types documented in the research. Use `export type` for all interfaces.

4. Create `src/claude/polyfills.ts`:

   ```typescript
   // Promise.withResolvers polyfill for Node.js 20 (ES2024 feature, native in Node 22+)
   // Must be imported before any code that uses Promise.withResolvers()
   if (typeof Promise.withResolvers !== 'function') {
     Promise.withResolvers = function <T>() {
       let resolve!: (value: T | PromiseLike<T>) => void;
       let reject!: (reason?: unknown) => void;
       const promise = new Promise<T>((res, rej) => {
         resolve = res;
         reject = rej;
       });
       return { promise, resolve, reject };
     };
   }

   export {};  // Ensure this is treated as a module
   ```

   Note: The global type declaration for `Promise.withResolvers` is NOT needed since we changed lib to ES2024 which includes it natively.

5. Update `src/index.ts` to re-export the new Claude types:
   ```typescript
   export type {
     CommandResult,
     RunCommandOptions,
     QuestionEvent,
     QuestionItem,
     QuestionOption,
   } from './claude/types.js';
   ```

   Add these type re-exports alongside the existing ones.
  </action>
  <verify>
Run `cd autopilot && npm run typecheck` -- must pass with zero errors.
Run `cd autopilot && npm run build` -- must compile successfully.
Verify `@anthropic-ai/claude-agent-sdk` appears in package.json dependencies.
  </verify>
  <done>
CommandResult, RunCommandOptions, QuestionEvent, QuestionItem, and QuestionOption types are defined and importable from the package entry point. Promise.withResolvers polyfill exists. Agent SDK is installed. TypeScript compiles with ES2024 lib.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create timeout utility with tests</name>
  <files>
    autopilot/src/claude/timeout.ts
    autopilot/src/claude/__tests__/timeout.test.ts
  </files>
  <action>
1. Create `src/claude/timeout.ts`:

   ```typescript
   export interface TimeoutHandle {
     controller: AbortController;
     cleanup: () => void;
   }

   /**
    * Creates an AbortController that automatically aborts after timeoutMs.
    * Call cleanup() in a finally block to prevent dangling timers.
    */
   export function createTimeout(timeoutMs: number): TimeoutHandle {
     const controller = new AbortController();
     const timer = setTimeout(() => controller.abort(), timeoutMs);
     // Prevent timer from keeping Node.js process alive
     if (timer && typeof timer === 'object' && 'unref' in timer) {
       timer.unref();
     }
     const cleanup = () => clearTimeout(timer);
     return { controller, cleanup };
   }
   ```

   Key details:
   - Use `timer.unref()` so the timeout does not keep the Node.js process alive (prevents vitest hang per research pitfall 5).
   - Return both controller and cleanup so the caller can wire `controller` into SDK options and call `cleanup()` in finally.

2. Create `src/claude/__tests__/timeout.test.ts` with these test cases:

   - `createTimeout returns an AbortController and cleanup function`: Verify the returned object has `controller` (instanceof AbortController) and `cleanup` (typeof function).
   - `controller is not aborted initially`: Create timeout with 1000ms, assert `controller.signal.aborted` is false.
   - `controller aborts after timeout`: Create timeout with 50ms, wait 100ms (via setTimeout + promise), assert `controller.signal.aborted` is true.
   - `cleanup prevents abort`: Create timeout with 50ms, call `cleanup()` immediately, wait 100ms, assert `controller.signal.aborted` is still false.
   - `abort fires AbortError on signal`: Create timeout with 50ms, add event listener on `controller.signal` for 'abort', wait 100ms, verify listener was called.

   Use `vitest` (describe/it/expect) following the existing test patterns from Phase 1.
  </action>
  <verify>
Run `cd autopilot && npx vitest run src/claude/__tests__/timeout.test.ts` -- all tests must pass.
Run `cd autopilot && npm test` -- full suite must pass (no regressions).
  </verify>
  <done>
createTimeout utility creates an AbortController that aborts after the configured duration, cleanup prevents the abort, and timer.unref() prevents process hangs. All timeout tests pass alongside the full test suite.
  </done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes in autopilot/ directory
- `npm run build` succeeds in autopilot/ directory
- `npm test` runs all tests (existing + new timeout tests) with zero failures
- `@anthropic-ai/claude-agent-sdk` is in package.json dependencies
- Types are importable from package entry point
</verification>

<success_criteria>
- CommandResult, RunCommandOptions, QuestionEvent types defined and exported
- Promise.withResolvers polyfill exists for Node 20 compatibility
- createTimeout utility works correctly with 5 passing tests
- Agent SDK installed as dependency
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/02-claude-integration/02-01-SUMMARY.md`
</output>
