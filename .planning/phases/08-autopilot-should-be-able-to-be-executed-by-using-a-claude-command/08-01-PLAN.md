---
phase: 08-autopilot-should-be-able-to-be-executed-by-using-a-claude-command
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - autopilot/workflows/gsd-autopilot/port-manager.js
  - autopilot/workflows/gsd-autopilot/__tests__/port-manager.test.js
autonomous: true

must_haves:
  truths:
    - "Same branch name always produces the same initial port number"
    - "Port range is 3847-4846 (base 3847 + hash % 1000)"
    - "When initial port is taken, the next available port is assigned"
    - "Assigned port is persisted in autopilot-state.json under branches key"
    - "Previously persisted port is reused if still available"
  artifacts:
    - path: "autopilot/workflows/gsd-autopilot/port-manager.js"
      provides: "Deterministic branch-to-port mapping with collision detection and state persistence"
      exports: ["branchToPort", "isPortAvailable", "assignPort"]
      min_lines: 60
    - path: "autopilot/workflows/gsd-autopilot/__tests__/port-manager.test.js"
      provides: "Tests for hashing determinism, collision handling, state reuse"
      min_lines: 40
  key_links:
    - from: "autopilot/workflows/gsd-autopilot/port-manager.js"
      to: ".planning/autopilot-state.json"
      via: "fs read/write for persisted port"
      pattern: "autopilot-state\\.json"
---

<objective>
Create the port manager module with TDD that deterministically maps git branch names to ports and handles collision detection with state persistence.

Purpose: Multi-instance autopilot support requires each branch to get a stable, unique port. The port manager is the foundation for the launcher and SKILL.md to assign and reuse ports reliably.

Output: `autopilot/workflows/gsd-autopilot/port-manager.js` with full test coverage.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-autopilot-should-be-able-to-be-executed-by-using-a-claude-command/08-RESEARCH.md

# Key reference for state file schema
@autopilot/src/types/state.ts
</context>

<feature>
  <name>Port Manager — Deterministic Branch-to-Port Assignment</name>
  <files>
    autopilot/workflows/gsd-autopilot/port-manager.js
    autopilot/workflows/gsd-autopilot/__tests__/port-manager.test.js
  </files>
  <behavior>
    This module exports three functions:

    1. `branchToPort(branchName)` — Pure function. SHA-256 hash of branch name, take first 8 hex chars as integer, return BASE_PORT (3847) + (hash % 1000). Deterministic: same input always gives same output.
       - "main" -> some port in [3847, 4846]
       - "feature/auth" -> some different port in [3847, 4846]
       - Calling twice with same input -> same result

    2. `isPortAvailable(port)` — Async function. Creates a net.createServer(), tries to listen on port. Returns true if listen succeeds (then closes), false on EADDRINUSE or any error. Host: '127.0.0.1'.

    3. `assignPort(branch, projectDir)` — Async function. The main entry point:
       a. Read `.planning/autopilot-state.json` in projectDir — if `branches[branch].port` exists AND that port is available, return it (reuse persisted port)
       b. Otherwise, call `branchToPort(branch)` for initial port
       c. If that port is not available, increment +1 until finding a free port (up to BASE_PORT + PORT_RANGE, then throw)
       d. Write the assigned port back to state file under `branches[branch] = { port, assignedAt: ISO timestamp }`
       e. Return the port number

    The module is a plain .js file (ESM) — NOT TypeScript — because it runs directly from `~/.claude/skills/` via the SKILL.md launcher, outside the TypeScript build pipeline.

    Test cases:
    - branchToPort('main') returns number in [3847, 4846]
    - branchToPort('main') called twice returns same value (deterministic)
    - branchToPort('main') !== branchToPort('feature/auth') (different branches -> different ports, with high probability)
    - assignPort reads persisted port from state file and reuses it
    - assignPort falls through to hash when no state file exists
    - assignPort increments port when initial hash port is unavailable
    - assignPort writes the assigned port back to state file
    - assignPort throws when no ports available in range
  </behavior>
  <implementation>
    Use Node.js built-in `crypto.createHash('sha256')` for hashing. Use `node:net` createServer for port checking. Use `node:fs/promises` for state file read/write. The state file path is `path.join(projectDir, '.planning', 'autopilot-state.json')`.

    For the test file, use Node.js built-in `node:test` and `node:assert` (NOT vitest) since this is a standalone .js module outside the autopilot TypeScript project. Mock `isPortAvailable` in tests to avoid actual network calls for the `assignPort` tests. Use `fs.mkdtemp` for temporary directories to test state file persistence.

    Constants: BASE_PORT = 3847, PORT_RANGE = 1000.
  </implementation>
</feature>

<verification>
```bash
cd autopilot && node --test workflows/gsd-autopilot/__tests__/port-manager.test.js
```
All tests pass. The port-manager.js file exports branchToPort, isPortAvailable, and assignPort.
</verification>

<success_criteria>
- branchToPort is deterministic (same input -> same output across calls)
- Port range is [3847, 4846]
- assignPort reuses persisted port from state file when available
- assignPort falls back to hash + collision detection when no persisted port
- assignPort writes back to state file after assignment
- All tests pass with `node --test`
</success_criteria>

<output>
After completion, create `.planning/phases/08-autopilot-should-be-able-to-be-executed-by-using-a-claude-command/08-01-SUMMARY.md`
</output>
