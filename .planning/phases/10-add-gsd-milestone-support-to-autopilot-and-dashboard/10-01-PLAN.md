---
phase: 10-add-gsd-milestone-support-to-autopilot-and-dashboard
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - autopilot/src/milestone/types.ts
  - autopilot/src/milestone/parser.ts
  - autopilot/src/milestone/__tests__/parser.test.ts
  - autopilot/src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Parser extracts current milestone version and name from PROJECT.md"
    - "Parser extracts shipped milestone entries from MILESTONES.md"
    - "Parser extracts milestone-to-phase mappings from ROADMAP.md progress table"
    - "Parser returns empty/null gracefully when files are missing (ENOENT)"
    - "Active milestone is correctly determined by cross-referencing PROJECT.md and MILESTONES.md"
  artifacts:
    - path: "autopilot/src/milestone/types.ts"
      provides: "MilestoneStatus, MilestoneInfo, MilestoneResponse types"
      exports: ["MilestoneStatus", "MilestoneInfo", "MilestoneResponse"]
    - path: "autopilot/src/milestone/parser.ts"
      provides: "Markdown parsing functions for milestone data from three sources"
      exports: ["parseMilestoneData"]
    - path: "autopilot/src/milestone/__tests__/parser.test.ts"
      provides: "TDD tests covering parser edge cases"
      min_lines: 80
  key_links:
    - from: "autopilot/src/milestone/parser.ts"
      to: "autopilot/src/milestone/types.ts"
      via: "type imports"
      pattern: "import.*MilestoneInfo.*from.*types"
    - from: "autopilot/src/types/index.ts"
      to: "autopilot/src/milestone/types.ts"
      via: "barrel re-export"
      pattern: "export.*from.*milestone/types"
---

<objective>
Create the milestone type definitions and markdown parser that extracts milestone data from three GSD planning files (PROJECT.md, MILESTONES.md, ROADMAP.md).

Purpose: This is the data foundation for all milestone features. The parser must handle missing files gracefully, parse flexible markdown formats with regex, and cross-reference sources to determine which milestone is active vs shipped.

Output: `autopilot/src/milestone/types.ts` with milestone types, `autopilot/src/milestone/parser.ts` with parsing functions, and comprehensive TDD tests.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-add-gsd-milestone-support-to-autopilot-and-dashboard/10-RESEARCH.md
@autopilot/src/types/index.ts
@autopilot/src/server/routes/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Milestone types and parser with TDD</name>
  <files>
    autopilot/src/milestone/types.ts
    autopilot/src/milestone/parser.ts
    autopilot/src/milestone/__tests__/parser.test.ts
    autopilot/src/types/index.ts
  </files>
  <action>
**Types (autopilot/src/milestone/types.ts):**

Define and export the following types using `export type` (consistent with verbatimModuleSyntax):

```typescript
export type MilestoneStatus = 'active' | 'shipped';

export type MilestoneInfo = {
  version: string;       // e.g. "v1.0"
  name: string;          // e.g. "MVP"
  status: MilestoneStatus;
  shippedDate?: string;  // ISO date string, only for shipped milestones
  phaseCount: number;    // Number of phases in this milestone
  planCount: number;     // Number of plans across all milestone phases
  phasesCompleted: number; // Number of completed phases
  accomplishments: string[]; // Key accomplishments (from MILESTONES.md)
};

export type MilestoneResponse = {
  current: MilestoneInfo | null;  // Active milestone or null
  shipped: MilestoneInfo[];       // Shipped milestones (most recent first)
};
```

**Parser (autopilot/src/milestone/parser.ts):**

Create `parseMilestoneData(planningDir: string): MilestoneResponse` that:

1. **Reads PROJECT.md** — extracts current milestone version and name from `## Current Milestone: v[X.Y] [Name]` section header. Use flexible regex: `/##\s+Current Milestone:\s+(v[\d.]+)\s+(.+)/`. Return null if section missing or file doesn't exist.

2. **Reads MILESTONES.md** — extracts shipped milestone entries. Each entry follows the template format:
   - Header: `## v[X.Y] [Name] (Shipped: YYYY-MM-DD)`
   - Body sections: `**Delivered:**`, `**Phases completed:**`, `**Key accomplishments:**`, `**Stats:**`
   - Use flexible regex with `\s+` for whitespace tolerance
   - Extract: version, name, shippedDate, accomplishments (bullet list items)
   - Parse stats section for plan count (match "N plans" pattern)
   - Parse "Phases completed" for phase count (match "X-Y" range or "X" count pattern)
   - Return empty array if file doesn't exist (ENOENT — not an error, just no milestones yet)

3. **Reads ROADMAP.md** — extracts phase-to-milestone mapping from the progress table. The progress table has columns like `| Phase | Plans Complete | Status | Completed |`. For the active milestone, count phases listed under it. Also count total plans from the "Plans" field in phase detail sections. Use this to populate `phaseCount`, `planCount`, and `phasesCompleted` for the active milestone.

4. **Cross-references sources** to build the response:
   - If PROJECT.md has a "Current Milestone" AND that version does NOT appear in MILESTONES.md shipped entries → it's active
   - If PROJECT.md has a "Current Milestone" AND that version IS in MILESTONES.md → the milestone was just shipped (status: 'shipped')
   - If PROJECT.md has no "Current Milestone" section → current is null
   - Shipped milestones come from MILESTONES.md entries

5. **Error handling:** Wrap all file reads in try-catch. ENOENT returns empty/null (graceful degradation). Re-throw unexpected errors. Log nothing (pure function, caller handles logging).

**Barrel export (autopilot/src/types/index.ts):**

Add milestone type re-exports at the end:
```typescript
export type {
  MilestoneStatus,
  MilestoneInfo,
  MilestoneResponse,
} from '../milestone/types.js';
```

**TDD tests (autopilot/src/milestone/__tests__/parser.test.ts):**

Follow RED-GREEN-REFACTOR. Use vitest. Mock `fs.readFileSync` to provide test markdown content. Test cases:

1. **Happy path**: All three files present with valid content → returns active milestone with correct stats and shipped milestones
2. **No MILESTONES.md** (ENOENT): Returns current milestone as active, empty shipped array
3. **No PROJECT.md** (ENOENT): Returns current as null
4. **No Current Milestone section** in PROJECT.md: Returns current as null
5. **Milestone just shipped**: Current milestone version appears in MILESTONES.md → status 'shipped'
6. **Multiple shipped milestones**: Parses all entries, returns in order
7. **Flexible whitespace**: Extra spaces in headers still match
8. **Empty MILESTONES.md**: Returns empty shipped array (not error)
9. **Decimal phase numbers**: Phases like "03.1" correctly parsed and counted

Use sample markdown content matching the actual GSD template format from `templates/milestone.md`.
  </action>
  <verify>
Run `cd autopilot && npx vitest run src/milestone/__tests__/parser.test.ts` — all tests pass.
Run `cd autopilot && npx tsc --noEmit` — no type errors.
  </verify>
  <done>
Parser correctly extracts milestone data from all three markdown sources, handles missing files gracefully, and cross-references to determine active vs shipped status. All TDD tests pass. Types are exported from barrel.
  </done>
</task>

</tasks>

<verification>
- `npx vitest run src/milestone/__tests__/parser.test.ts` passes all test cases
- `npx tsc --noEmit` compiles without errors
- Types are importable: `import type { MilestoneInfo } from './types/index.js'`
- Parser handles ENOENT for all three files without throwing
</verification>

<success_criteria>
- Milestone types defined with correct shape matching research spec
- Parser extracts data from PROJECT.md, MILESTONES.md, and ROADMAP.md
- Missing files return null/empty (not errors)
- Active vs shipped milestone correctly determined by cross-referencing sources
- All tests pass with comprehensive edge case coverage
</success_criteria>

<output>
After completion, create `.planning/phases/10-add-gsd-milestone-support-to-autopilot-and-dashboard/10-01-SUMMARY.md`
</output>
