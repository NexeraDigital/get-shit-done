---
phase: 11-use-microsoft-dev-tunnels-to-create-public-urls-for-remote-dashboard-access
plan: "03"
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - dashboard/src/components/TunnelBanner.tsx
  - dashboard/src/pages/Overview.tsx
  - dashboard/src/store.ts
  - dashboard/src/api.ts
  - autopilot/src/notifications/adapters/console.ts
  - autopilot/src/cli/index.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard UI displays tunnel URL prominently when available"
    - "Every notification includes tunnel URL for remote access"
    - "User can copy tunnel URL from dashboard with one click"
    - "Dashboard gracefully shows localhost URL when tunnel is disabled"
  artifacts:
    - path: "dashboard/src/components/TunnelBanner.tsx"
      provides: "TunnelBanner component displaying public URL"
      min_lines: 30
    - path: "dashboard/src/pages/Overview.tsx"
      provides: "TunnelBanner integration in Overview page"
      contains: "TunnelBanner"
    - path: "dashboard/src/store.ts"
      provides: "tunnelUrl field in dashboard state"
      contains: "tunnelUrl"
    - path: "autopilot/src/notifications/adapters/console.ts"
      provides: "Tunnel URL in console notifications"
      contains: "tunnelUrl"
  key_links:
    - from: "dashboard/src/components/TunnelBanner.tsx"
      to: "dashboard/src/store.ts"
      via: "Zustand selector for tunnelUrl"
      pattern: "useStore.*tunnelUrl"
    - from: "dashboard/src/api.ts"
      to: "/api/status endpoint"
      via: "Fetch state including tunnelUrl"
      pattern: "tunnelUrl"
    - from: "autopilot/src/notifications/adapters/console.ts"
      to: "notification body"
      via: "Append tunnel URL to all notifications"
      pattern: "tunnelUrl.*respondUrl"
---

<objective>
Surface tunnel URL in dashboard UI with a prominent banner, integrate tunnel URL into all notifications for remote access, and ensure graceful UI when tunnel is disabled or unavailable.

Purpose: Make the tunnel URL discoverable and accessible so users can remotely access the dashboard from phones or other devices, and ensure every notification includes the public URL per user decision.

Output: Dashboard displays tunnel URL, notifications include tunnel URL, users can copy/share the link easily.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-use-microsoft-dev-tunnels-to-create-public-urls-for-remote-dashboard-access/11-RESEARCH.md
@.planning/phases/11-use-microsoft-dev-tunnels-to-create-public-urls-for-remote-dashboard-access/11-CONTEXT.md
@.planning/phases/11-use-microsoft-dev-tunnels-to-create-public-urls-for-remote-dashboard-access/11-01-SUMMARY.md
@.planning/phases/11-use-microsoft-dev-tunnels-to-create-public-urls-for-remote-dashboard-access/11-02-SUMMARY.md
@dashboard/src/store.ts
@dashboard/src/api.ts
@dashboard/src/pages/Overview.tsx
@autopilot/src/notifications/adapters/console.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tunnelUrl to dashboard state and API client</name>
  <files>
    dashboard/src/store.ts
    dashboard/src/api.ts
  </files>
  <action>
1. In `dashboard/src/store.ts`, add `tunnelUrl` field to `DashboardState` interface:
   ```typescript
   export interface DashboardState {
     // ... existing fields ...
     tunnelUrl: string | null; // Public dev-tunnel URL, null if disabled or failed
   }
   ```

2. In the Zustand store initialState, add:
   ```typescript
   tunnelUrl: null,
   ```

3. Add a setter action to update tunnelUrl:
   ```typescript
   setTunnelUrl: (url: string | null) => set({ tunnelUrl: url }),
   ```

4. In `dashboard/src/api.ts`, update `fetchStatus()` to include tunnelUrl in the returned state:
   - The server's GET /api/status endpoint already returns full state (including tunnelUrl from Plan 02)
   - No server changes needed -- just ensure client extracts tunnelUrl from response and calls `setTunnelUrl()`

5. In the SSE useEffect hook in the Layout component (or wherever SSE state hydration happens), ensure tunnelUrl is extracted from the initial /api/status fetch and set in store.
  </action>
  <verify>
    - `cd dashboard && npx tsc --noEmit` compiles without errors
    - Grep for tunnelUrl in store: `grep -n tunnelUrl dashboard/src/store.ts`
    - Grep for setTunnelUrl: `grep -n setTunnelUrl dashboard/src/store.ts`
  </verify>
  <done>
    Dashboard state includes tunnelUrl field, API client fetches it from /api/status, and store provides setter for updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TunnelBanner component and integrate into Overview page</name>
  <files>
    dashboard/src/components/TunnelBanner.tsx
    dashboard/src/pages/Overview.tsx
  </files>
  <action>
1. Create `dashboard/src/components/TunnelBanner.tsx`:

   **Component structure:**
   - Accepts no props (reads from Zustand store via `const tunnelUrl = useStore((s) => s.tunnelUrl);`)
   - If tunnelUrl is null: render nothing (no banner)
   - If tunnelUrl is non-null:
     - Show a banner at the top of the page with:
       - Icon: Globe/Link icon (use CSS-only icon or Unicode symbol like ðŸŒ)
       - Text: "Remote access enabled"
       - Clickable URL: Display tunnel URL as a link (opens in new tab)
       - Copy button: Click to copy URL to clipboard (use navigator.clipboard.writeText)
       - Styling: Light blue/purple background (bg-purple-50), border, padding, rounded corners
       - Position: Full-width banner above main content

   **Copy functionality:**
   - On button click: `navigator.clipboard.writeText(tunnelUrl)`
   - Show temporary "Copied!" feedback (state: `const [copied, setCopied] = useState(false)`)
   - Reset after 2 seconds: `setTimeout(() => setCopied(false), 2000)`

   **Responsive design:**
   - Desktop: URL shown in full, side-by-side with copy button
   - Mobile: URL truncated with ellipsis, copy button below

2. In `dashboard/src/pages/Overview.tsx`, import TunnelBanner and render it at the top of the page (before ProgressBar or other content):
   ```tsx
   <TunnelBanner />
   <ProgressBar ... />
   {/* rest of overview content */}
   ```

Follow existing dashboard patterns:
- Tailwind CSS for styling (consistent with PhaseCard, ProgressBar, etc.)
- Minimal external dependencies (no icon library -- use Unicode or CSS)
- Functional component with hooks
  </action>
  <verify>
    - `cd dashboard && npx tsc --noEmit` compiles without errors
    - `cd dashboard && npm run build` succeeds
    - Grep for TunnelBanner in Overview: `grep -n TunnelBanner dashboard/src/pages/Overview.tsx`
    - Component file exists: `ls dashboard/src/components/TunnelBanner.tsx`
  </verify>
  <done>
    TunnelBanner component displays tunnel URL with copy button, integrated into Overview page at the top, uses Zustand store for reactive updates, and gracefully hides when tunnel is disabled.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ConsoleAdapter to include tunnel URL in all notifications</name>
  <files>
    autopilot/src/notifications/adapters/console.ts
    autopilot/src/cli/index.ts
  </files>
  <action>
1. In `autopilot/src/notifications/adapters/console.ts`, update the `format()` method (or wherever notification body text is built) to append tunnel URL to every notification:

   **Approach:**
   - ConsoleAdapter needs access to the current tunnel URL
   - Pass tunnel URL as part of initialization or via a getter function in the constructor options:
     ```typescript
     constructor(options: {
       stopSpinner?: () => void;
       output?: WritableOutput;
       port?: number;
       getTunnelUrl?: () => string | null; // NEW: callback to get current tunnel URL
     })
     ```
   - Store `getTunnelUrl` as private field
   - In `format()` method, after building the main notification message:
     ```typescript
     const tunnelUrl = this.getTunnelUrl?.() || null;
     const baseUrl = tunnelUrl || `http://localhost:${this.port}`;
     // Append dashboard access info to every notification body
     message += `\n\n${palette.dim('Dashboard:')} ${baseUrl}`;
     ```

2. In `autopilot/src/cli/index.ts`, when creating ConsoleAdapter, provide the `getTunnelUrl` callback:
   - After TunnelManager is created and started (or failed), store tunnel URL in a variable accessible to the callback
   - Pass to ConsoleAdapter: `new ConsoleAdapter({ ..., getTunnelUrl: () => tunnelManager?.url || null })`

Key decision from CONTEXT.md:
- "Every notification (questions, progress, errors) includes the tunnel URL â€” not just a one-time startup message"
- This ensures users can tap/click the link from their phone notifications to access the dashboard remotely
  </action>
  <verify>
    - `cd autopilot && npx tsc --noEmit` compiles without errors
    - Grep for getTunnelUrl in ConsoleAdapter: `grep -n getTunnelUrl autopilot/src/notifications/adapters/console.ts`
    - Grep for getTunnelUrl in CLI: `grep -n getTunnelUrl autopilot/src/cli/index.ts`
  </verify>
  <done>
    ConsoleAdapter includes tunnel URL (or localhost fallback) in every notification body, enabling remote dashboard access from notification messages. CLI wires tunnel URL callback to adapter.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles: `cd autopilot && npx tsc --noEmit && cd dashboard && npx tsc --noEmit`
- Dashboard builds: `cd dashboard && npm run build`
- TunnelBanner component exists and is imported in Overview page
- ConsoleAdapter includes tunnel URL in notifications
- tunnelUrl field present in dashboard store and API client
</verification>

<success_criteria>
Dashboard displays tunnel URL in a prominent banner with copy button, all notifications include tunnel URL for remote access, and UI gracefully handles disabled/unavailable tunnel state. Code compiles and follows existing dashboard patterns (Tailwind CSS, Zustand, minimal dependencies).
</success_criteria>

<output>
After completion, create `.planning/phases/11-use-microsoft-dev-tunnels-to-create-public-urls-for-remote-dashboard-access/11-03-SUMMARY.md`
</output>
