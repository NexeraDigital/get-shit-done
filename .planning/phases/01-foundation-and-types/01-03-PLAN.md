---
phase: 01-foundation-and-types
plan: 03
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - autopilot/src/config/index.ts
  - autopilot/src/config/__tests__/config-loader.test.ts
autonomous: true

must_haves:
  truths:
    - "Config loads from .gsd-autopilot.json when file exists"
    - "Config uses sensible defaults when no file, env vars, or CLI flags are present"
    - "CLI flags override environment variables override config file override defaults"
    - "Environment variables with GSD_AUTOPILOT_ prefix are recognized and type-coerced"
    - "Invalid config file produces a clear error message (not a raw ZodError stack trace)"
    - "Missing config file is not an error -- defaults are used"
  artifacts:
    - path: "autopilot/src/config/index.ts"
      provides: "loadConfig function with precedence chain"
      exports: ["loadConfig"]
      min_lines: 50
    - path: "autopilot/src/config/__tests__/config-loader.test.ts"
      provides: "TDD tests for config loading"
      min_lines: 80
  key_links:
    - from: "autopilot/src/config/index.ts"
      to: "autopilot/src/types/config.ts"
      via: "Zod schema import for validation"
      pattern: "import.*AutopilotConfigSchema.*from.*types"
    - from: "autopilot/src/config/index.ts"
      to: "node:fs/promises"
      via: "file reading for config file"
      pattern: "import.*readFile.*from.*node:fs"
    - from: "autopilot/src/config/index.ts"
      to: "node:path"
      via: "path construction for config file location"
      pattern: "import.*join.*from.*node:path"
---

<objective>
Build the config loading system using TDD -- loads configuration from defaults, file, environment variables, and CLI flags with proper precedence.

Purpose: Config loading is the first thing that runs at startup. It determines notification channels, server port, verbosity, and execution parameters. The precedence chain (CLI > env > file > defaults) must be correct, and malformed config files must produce helpful errors instead of crashes. This is requirement CLI-12.
Output: A fully tested loadConfig() function with precedence chain, env var parsing, and Zod validation.
</objective>

<execution_context>
@C:\Users\russw\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\russw\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-and-types/01-RESEARCH.md
@.planning/phases/01-foundation-and-types/01-01-SUMMARY.md
</context>

<feature>
  <name>Config Loader with Precedence Chain</name>
  <files>autopilot/src/config/index.ts, autopilot/src/config/__tests__/config-loader.test.ts</files>
  <behavior>
    loadConfig(projectDir, cliFlags) loads and merges config from multiple sources with precedence: CLI flags > environment variables > config file > Zod defaults.

    Test cases (input -> expected output):

    1. loadConfig(dir, {}) with no file, no env -> returns all defaults (port: 3847, depth: 'standard', notify: 'console', etc.)
    2. loadConfig(dir, {}) with .gsd-autopilot.json containing { "port": 4000 } -> returns port: 4000, other fields at defaults
    3. loadConfig(dir, { port: 5000 }) with .gsd-autopilot.json containing { "port": 4000 } -> returns port: 5000 (CLI wins)
    4. loadConfig(dir, {}) with GSD_AUTOPILOT_PORT=4000 env var -> returns port: 4000
    5. loadConfig(dir, { port: 5000 }) with GSD_AUTOPILOT_PORT=4000 env var -> returns port: 5000 (CLI wins over env)
    6. loadConfig(dir, {}) with GSD_AUTOPILOT_PORT=4000 env var AND .gsd-autopilot.json { "port": 3000 } -> returns port: 4000 (env wins over file)
    7. Full precedence: file has port 3000, env has port 4000, CLI has port 5000 -> returns port: 5000
    8. loadConfig(dir, {}) with .gsd-autopilot.json containing invalid JSON -> throws clear error: "Invalid config file" (not ZodError)
    9. loadConfig(dir, {}) with .gsd-autopilot.json containing { "port": "not-a-number" } -> throws clear validation error
    10. loadConfig(dir, {}) with GSD_AUTOPILOT_SKIP_DISCUSS=true env var -> returns skipDiscuss: true (boolean coercion from string)
    11. loadConfig(dir, {}) with GSD_AUTOPILOT_VERBOSE=false env var -> returns verbose: false (boolean coercion)
    12. loadConfig(dir, {}) with GSD_AUTOPILOT_NOTIFY=teams env var -> returns notify: 'teams' (string passthrough)
    13. Config file path uses path.join(projectDir, '.gsd-autopilot.json') -- no hardcoded separators (FNDN-03)
    14. Env var key mapping: GSD_AUTOPILOT_WEBHOOK_URL -> webhookUrl (snake_case to camelCase)
    15. loadConfig(dir, {}) with no config file -> returns defaults (missing file is not an error)

    Environment variable parsing rules:
    - Prefix: GSD_AUTOPILOT_ (per user decision)
    - Strip prefix, lowercase, convert snake_case to camelCase
    - Type coercion: "true"/"false" -> boolean, numeric strings -> number, else string
  </behavior>
  <implementation>
    Create src/config/index.ts following the pattern from 01-RESEARCH.md:

    - Import AutopilotConfigSchema from '../types/index.js' (the Zod schema defined in Plan 01)
    - Import readFile from 'node:fs/promises'
    - Import join from 'node:path' (FNDN-03)

    loadConfig(projectDir: string, cliFlags: Partial<AutopilotConfig>): Promise<AutopilotConfig>
    1. Start with empty merge object
    2. Try reading join(projectDir, '.gsd-autopilot.json') -- if exists, JSON.parse it. If JSON.parse fails, throw clear error. If file not found (ENOENT), skip silently.
    3. Call loadEnvVars() to extract GSD_AUTOPILOT_* env vars with type coercion
    4. Merge: { ...fileConfig, ...envConfig, ...cliFlags }
    5. Validate with AutopilotConfigSchema.safeParse() -- per research recommendation, use safeParse for user-facing input
    6. If validation fails, throw clear error with field-level details (not raw ZodError)
    7. Return validated config

    loadEnvVars(): Record<string, unknown>
    - Iterate process.env entries starting with GSD_AUTOPILOT_
    - Strip prefix, lowercase, snake_case -> camelCase conversion
    - Type coercion: "true"/"false" -> boolean, /^\d+$/ -> parseInt, else string
    - Return parsed object

    CRITICAL: Use safeParse() for config validation (user input may be malformed) -- per research pitfall #5
    CRITICAL: Pre-process env vars for type coercion BEFORE Zod validation -- per research pitfall #6
    CRITICAL: Use path.join() for config file path (FNDN-03)
    CRITICAL: All imports use .js extensions

    Export loadConfig from src/config/index.ts.
    Add re-export in src/index.ts: export { loadConfig } from './config/index.js'

    For tests: use vitest's vi.stubEnv() or process.env manipulation for env var tests. Use tmp directories with writeFileSync for config file tests. Clean up after each test.
  </implementation>
</feature>

<verification>
1. `cd autopilot && npm test` -- all config loader tests pass
2. `npm run build` -- compiles without errors
3. `npm run typecheck` -- no type errors
4. Verify config file path uses path.join() (grep confirms)
5. Verify safeParse is used for validation (not parse) since this is user-facing input
</verification>

<success_criteria>
- All TDD test cases pass (15+ tests covering defaults, file loading, env vars, CLI override, precedence, error handling, type coercion)
- loadConfig uses safeParse for validation with human-readable errors
- Environment variable prefix is GSD_AUTOPILOT_ (per user decision)
- Config file path is .gsd-autopilot.json in project root (per user decision)
- Precedence chain is CLI > env > file > defaults (per CLI-12 requirement)
- npm run build succeeds with loadConfig exported from package entry point
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-types/01-03-SUMMARY.md`
</output>
