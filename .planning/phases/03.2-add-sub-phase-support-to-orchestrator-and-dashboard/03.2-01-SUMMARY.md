---
phase: 03.2-add-sub-phase-support-to-orchestrator-and-dashboard
plan: 01
subsystem: orchestrator
tags: [tdd, types, roadmap-parsing, phase-extraction]
dependency-graph:
  requires: [orchestrator-core, state-types, roadmap-format]
  provides: [merged-phase-extraction, inserted-flag, depends-on-metadata]
  affects: [dashboard-phase-display, phase-visibility]
tech-stack:
  added: []
  patterns: [tdd-red-green-refactor, line-by-line-parsing, metadata-extraction]
key-files:
  created: []
  modified:
    - autopilot/src/orchestrator/index.ts
    - autopilot/src/types/state.ts
    - autopilot/src/orchestrator/__tests__/orchestrator.test.ts
decisions:
  - "extractDependsOn uses line-by-line parsing instead of complex regex (more reliable for multi-line content)"
  - "PhaseState fields inserted and dependsOn are optional for backwards compatibility"
  - "Checklist completion status is authoritative; heading metadata supplements it"
metrics:
  duration: 280s
  tasks-completed: 1
  files-modified: 3
  commits: 1
  tests-added: 5
  tests-total: 25
  completed-date: 2026-02-24
---

# Phase 03.2 Plan 01: Extend Types and Merge Extraction Summary

**One-liner:** Fixed extractPhasesFromContent to merge checklist and heading sources, making heading-only phases (03.1, 06.1, 8) visible with inserted/dependsOn metadata propagated to PhaseState.

## Overview

This plan fixed a critical bug where heading-only phases (inserted decimal phases like 03.1, 06.1, and integer phases like 8) were invisible to the orchestrator and dashboard because the heading parser only ran as a fallback when the checklist had zero entries. The fix merges both sources unconditionally, extracts metadata (inserted flag, dependsOn), and propagates these fields to PhaseState.

## Tasks Completed

| Task | Description | Commit | Files |
|------|-------------|--------|-------|
| 1 | Extend types and rewrite extractPhasesFromContent with TDD | c7a1dff | index.ts, state.ts, orchestrator.test.ts |

## Technical Implementation

### Type Extensions

**RoadmapPhase interface** (autopilot/src/orchestrator/index.ts):
```typescript
interface RoadmapPhase {
  number: number;
  name: string;
  completed: boolean;
  inserted: boolean;      // NEW: From (INSERTED) marker
  dependsOn: string | null; // NEW: From heading metadata
}
```

**PhaseState interface** (autopilot/src/types/state.ts):
```typescript
export interface PhaseState {
  // ... existing fields ...
  inserted?: boolean;        // Optional for backwards compatibility
  dependsOn?: string | null; // Optional for backwards compatibility
}
```

### Extraction Logic Rewrite

**extractPhasesFromContent** now follows a 3-step merge process:

1. **Step 1: Parse checklist entries**
   - Extract from `- [x] **Phase N: Name**` format
   - Initialize with `inserted: false, dependsOn: null`

2. **Step 2: Parse heading entries UNCONDITIONALLY** (key fix)
   - Extract from `### Phase N: Name (INSERTED)` format
   - If phase exists (from checklist): merge metadata
   - If phase doesn't exist: create new entry with `completed: false`
   - Detect `(INSERTED)` marker → set `inserted: true`
   - Call `extractDependsOn()` for each heading

3. **Step 3: Sort numerically**
   - Sort by `(a, b) => a.number - b.number`
   - Result: `[1, 3, 3.1, 3.2, 6.1, 7, 8]`

### Metadata Extraction

**extractDependsOn helper function**:
- Uses line-by-line parsing (more reliable than complex regex)
- Handles leading-zero formats (03.1 vs 3.1)
- Searches for `**Depends on:** Phase X` in heading block
- Returns extracted value or null

**Key decision:** Line-by-line parsing instead of complex regex with lookaheads. Complex multi-line regex had edge cases with empty lines and non-greedy quantifiers. Line-by-line approach is more maintainable and reliable.

### Test Coverage

Added 5 new TDD tests in RED-GREEN-REFACTOR cycle:

1. **merges checklist and heading-only phases** - Verifies all 6 phases returned (3 checklist + 3 heading)
2. **extracts inserted flag from (INSERTED) marker** - Phase 03.2 has `inserted: true`
3. **extracts dependsOn from heading section** - Phase 03.1 has `dependsOn: 'Phase 3'`
4. **merges heading metadata into checklist phases** - Phase 3 gets `inserted: true` from heading even though in checklist
5. **sorts phases numerically after merge** - Verifies correct numeric sort order

Updated 4 existing tests to include new fields in expectations (backwards compatibility check).

All tests pass: 25/25 orchestrator tests, 729 total tests across entire codebase.

## Verification Results

1. `cd autopilot && npx vitest run src/orchestrator/__tests__/orchestrator.test.ts` - ✓ All 25 tests pass
2. `cd autopilot && npx vitest run` - ✓ 729 tests pass (1 pre-existing failure in unrelated port-manager.test.js)
3. `cd autopilot && npx tsc --noEmit` - ✓ TypeScript compiles cleanly

## Deviations from Plan

None - plan executed exactly as written.

## Impact

**Before:** Heading-only phases (03.1, 06.1, 8) invisible to orchestrator and dashboard
**After:** All phases visible, sorted correctly, with metadata propagated

**Downstream benefits:**
- Dashboard can display INSERTED badge for inserted phases (Plan 02)
- Orchestrator can access dependsOn for dependency validation
- Phase visibility is complete and accurate

## Self-Check: PASSED

Created files: None (all modifications)

Modified files exist:
- ✓ autopilot/src/orchestrator/index.ts
- ✓ autopilot/src/types/state.ts
- ✓ autopilot/src/orchestrator/__tests__/orchestrator.test.ts

Commit exists:
- ✓ c7a1dff (feat(03.2-01): extend types and merge checklist+heading extraction with TDD)

All files verified present on disk and committed.
