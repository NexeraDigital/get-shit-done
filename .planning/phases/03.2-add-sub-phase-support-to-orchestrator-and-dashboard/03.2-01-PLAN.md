---
phase: 03.2-add-sub-phase-support-to-orchestrator-and-dashboard
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - autopilot/src/orchestrator/index.ts
  - autopilot/src/orchestrator/__tests__/orchestrator.test.ts
  - autopilot/src/types/state.ts
autonomous: true

must_haves:
  truths:
    - "extractPhasesFromContent returns all phases from ROADMAP.md including heading-only phases (03.1, 06.1, 8)"
    - "Phases are sorted numerically: 1 < 3 < 3.1 < 3.2 < 4 < 6 < 6.1 < 7 < 8"
    - "Inserted phases have inserted: true extracted from (INSERTED) marker in heading"
    - "dependsOn field extracted from Depends on: line in heading sections"
    - "Checklist is authoritative for completion status; heading-only phases default to completed: false"
    - "toPhaseState propagates inserted and dependsOn fields to PhaseState"
  artifacts:
    - path: "autopilot/src/orchestrator/index.ts"
      provides: "Merged checklist+heading extraction, RoadmapPhase with inserted/dependsOn"
      contains: "inserted"
    - path: "autopilot/src/types/state.ts"
      provides: "PhaseState with optional inserted and dependsOn fields"
      contains: "inserted"
    - path: "autopilot/src/orchestrator/__tests__/orchestrator.test.ts"
      provides: "Tests covering merge, sorting, inserted detection, dependsOn extraction"
      contains: "heading-only phases"
  key_links:
    - from: "autopilot/src/orchestrator/index.ts"
      to: "autopilot/src/types/state.ts"
      via: "toPhaseState maps RoadmapPhase fields to PhaseState"
      pattern: "inserted.*dependsOn"
---

<objective>
Fix `extractPhasesFromContent` to merge both checklist and heading sources, extend `RoadmapPhase` interface with `inserted` and `dependsOn` fields, and propagate these to `PhaseState`.

Purpose: Currently heading-only phases (03.1, 06.1, 8) are invisible because the heading parser only runs as a fallback when the checklist has zero entries. This fix merges both sources unconditionally, making all phases visible to the orchestrator and dashboard.

Output: Updated extraction function with comprehensive tests, extended type interfaces.
</objective>

<execution_context>
@C:/Users/russw/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/russw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-add-sub-phase-support-to-orchestrator-and-dashboard/03.2-RESEARCH.md
@autopilot/src/orchestrator/index.ts
@autopilot/src/types/state.ts
@autopilot/src/orchestrator/__tests__/orchestrator.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend types and rewrite extractPhasesFromContent with TDD</name>
  <files>
    autopilot/src/types/state.ts
    autopilot/src/orchestrator/index.ts
    autopilot/src/orchestrator/__tests__/orchestrator.test.ts
  </files>
  <action>
**RED phase -- Write failing tests first:**

Add these test cases to the `extractPhasesFromContent` describe block in `orchestrator.test.ts`:

1. **"merges checklist and heading-only phases"** -- Provide content with checklist phases (1, 2, 3) and heading-only phases (3.1, 06.1, 8). Assert result contains ALL phases. Assert heading-only phases have `completed: false`. Assert checklist phases retain their completion status. Assert the array length matches total unique phases.

2. **"extracts inserted flag from (INSERTED) marker"** -- Provide content with `### Phase 03.2: Add Sub phase support (INSERTED)` heading. Assert `result.find(p => p.number === 3.2)?.inserted` is `true`. Assert non-inserted phases have `inserted: false`.

3. **"extracts dependsOn from heading section"** -- Provide content with heading block containing `**Depends on:** Phase 3`. Assert the matching phase has `dependsOn: 'Phase 3'`. Assert phases without Depends on line have `dependsOn: null`.

4. **"merges heading metadata into checklist phases"** -- Provide content where Phase 3 appears in BOTH checklist (completed) and heading (with INSERTED marker). Assert the merged phase has `completed: true` (from checklist, authoritative) AND `inserted: true` (from heading metadata).

5. **"sorts phases numerically after merge"** -- Provide content with phases in scrambled order: checklist has 7, 3, 1; headings have 3.2, 3.1, 06.1, 8. Assert result is sorted: [1, 3, 3.1, 3.2, 6.1, 7, 8].

6. **Update existing test expectations** -- Existing tests assert on the old 3-field shape `{ number, name, completed }`. Update them to also include `inserted: false, dependsOn: null` for checklist-only phases since the function now always returns these fields.

Run tests: `cd autopilot && npx vitest run src/orchestrator/__tests__/orchestrator.test.ts` -- all NEW tests must FAIL (RED).

**GREEN phase -- Implement the fix:**

1. **Extend `RoadmapPhase` interface** in `index.ts` (local interface, not exported):
   ```typescript
   interface RoadmapPhase {
     number: number;
     name: string;
     completed: boolean;
     inserted: boolean;
     dependsOn: string | null;
   }
   ```

2. **Rewrite `extractPhasesFromContent`**:
   - Step 1: Parse checklist entries (existing regex). Push with `inserted: false, dependsOn: null`.
   - Step 2: Parse heading entries UNCONDITIONALLY (remove the `if (phases.length === 0)` gate). For each heading match:
     - Check if phase number already exists in `phases` array (via `.find()`)
     - If exists: merge metadata -- set `inserted: true` if `(INSERTED)` in heading text, extract dependsOn
     - If not exists: push new entry with `completed: false`, detect inserted, extract dependsOn
   - Step 3: Extract `dependsOn` for each heading-matched phase by finding the `**Depends on:** ...` line in the content block between the heading and the next heading (or end of string). Use a helper function `extractDependsOn(content, phaseNumber)` as shown in research.
   - Step 4: Sort by `(a, b) => a.number - b.number`
   - Step 5: Return sorted array

   IMPORTANT: Declare regex patterns INSIDE the function body (not module-level) to avoid global flag state pollution between calls.

   Heading regex should match: `^#{1,3} Phase (\d+(?:\.\d+)?): (.+?)(\s+\(INSERTED\))?$` with `gm` flags.

   The checklist regex pattern already supports decimal phases: `\d+(?:\.\d+)?`.

3. **Extend `PhaseState`** in `autopilot/src/types/state.ts`:
   ```typescript
   export interface PhaseState {
     // ... existing fields ...
     inserted?: boolean;
     dependsOn?: string | null;
   }
   ```
   Use optional fields (`?`) for backwards compatibility with existing serialized state.

4. **Update `toPhaseState`** in `index.ts` to propagate new fields:
   ```typescript
   function toPhaseState(rp: RoadmapPhase): PhaseState {
     return {
       // ... existing fields ...
       inserted: rp.inserted,
       dependsOn: rp.dependsOn,
     };
   }
   ```

Run tests: `cd autopilot && npx vitest run src/orchestrator/__tests__/orchestrator.test.ts` -- ALL tests must PASS (GREEN).

Also run the full test suite to check for regressions: `cd autopilot && npx vitest run`

**REFACTOR phase (if needed):**
- Extract the `extractDependsOn` helper as a named function within `index.ts` (not exported, just for readability)
- Ensure no regex is declared at module level with /g flag
  </action>
  <verify>
    cd autopilot && npx vitest run src/orchestrator/__tests__/orchestrator.test.ts
    cd autopilot && npx vitest run
  </verify>
  <done>
    extractPhasesFromContent merges checklist and heading sources; returns all phases including heading-only ones (03.1, 06.1, 8) sorted numerically; inserted and dependsOn fields populated from heading metadata; all existing and new tests pass; PhaseState type extended with optional inserted/dependsOn fields; toPhaseState propagates new fields.
  </done>
</task>

</tasks>

<verification>
1. `cd autopilot && npx vitest run` -- all tests pass with zero failures
2. `cd autopilot && npx tsc --noEmit` -- TypeScript compiles with no errors
3. Manual verification: the actual project ROADMAP.md content, when passed to extractPhasesFromContent, returns phases including 03.1, 03.2, 06.1, and 8 (currently invisible)
</verification>

<success_criteria>
- extractPhasesFromContent returns all phases from ROADMAP.md (checklist + heading-only)
- Phases sorted numerically: decimal phases appear after their parent integer
- inserted field is true for phases with (INSERTED) marker, false otherwise
- dependsOn field extracted from heading blocks, null when absent
- PhaseState interface extended with optional inserted and dependsOn
- All tests pass (existing + new)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-add-sub-phase-support-to-orchestrator-and-dashboard/03.2-01-SUMMARY.md`
</output>
